// =================== ูุนุฑู ููู Master ุซุงุจุช ===================
var MASTER_SS_ID = "1UesLuAO9kSTeNGk8-1HJVTlzpojgIUjjVNZK_xq0s2c";

function getMasterSS() {
  return SpreadsheetApp.openById(MASTER_SS_ID);
}

// =================== ุงููุงุฆูุฉ ุนูุฏ ูุชุญ ุงูููู ===================
function onOpen() {
  SpreadsheetApp.getUi().createMenu('๐๏ธ ูุธุงู ุฃูุงุฏูููุฉ ูู ุฃูุช')
      .addItem('๐๏ธ ุชุฃุณูุณ ุงููุธุงู ุงููุงูู', 'setupFullSystem')
      .addItem('๐ ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุณูุฑ', 'fillSurahData')
      .addItem('๐ ุตูุงูุฉ ุงููุธุงู ุงููุงูู', 'fullSystemCheckup') // โ ุฎูุงุฑ ุฌุฏูุฏ ูููุญุต ูุงูุตูุงูุฉ
      .addToUi();
}

// =================== ุฅูุดุงุก ุงููุธุงู ุงููุงูู ===================
function setupFullSystem() {
  var ss = getMasterSS();

  // ูุงุฆูุฉ ุงูุฌุฏุงูู ูุน ุงูุฃุนูุฏุฉ ูุงูุฏูุงู ุงูุฎุงุตุฉ ุจุงูุชุนุจุฆุฉ
  var tables = [
    { name: "ุงูุฅุนุฏุงุฏุงุช", cols: ["ุงูุนููุงู","ุงููููุฉ","ููุงุญุธุงุช","ุงูููุน","ูุงุจู ููุชุนุฏูู","ุขุฎุฑ ุชุนุฏูู","ูุตุฏุฑ"], fill: fillSettings },
    { name: "ุงูุฌูุณุงุช", cols: ["sessionId","userId","deviceInfo","createdAt","expiresAt"] },
    { name: "PasswordResetLogs", cols: ["email","requestedAt","token","tokenUsed"] },
    { name: "ุงูุฃูุณุงู", cols: ["ูุนุฑู_ุงููุณู","ุงุณู_ุงููุณู","ุงุณู_ุตูุญุฉ_ุงููุณู","ูุณุงุฑ_ุงูุตูุญุฉ","ูุตู_ุงููุณู","ูุนุฑู_ุงููุณู_ุงูุฃุจ","ุชุฑุชูุจ_ุงูุนุฑุถ","ุงูุฃููููุฉ","ููู_ุงููุณู","ูุธูุฑ_ูู_ุงููุงุฆูุฉ","ููุน_ุงููุณู","ูุณุชูู_ุงูุตูุงุญูุฉ","ุงูุญุงูุฉ","ูุนุฑู_ุงููุฑุน","ุฃูุดุฆ_ุจูุงุณุทุฉ","ุชุงุฑูุฎ_ุงูุฅูุดุงุก","ุขุฎุฑ_ุชุญุฏูุซ","ููุงุญุธุงุช"] },
    { name: "ุงููุณุชุฎุฏููู", cols: ["ูุนุฑู_ุงููุณุชุฎุฏู","ุงูุงุณู_ุงููุงูู","ุงูุจุฑูุฏ_ุงูุฅููุชุฑููู","password_hash","salt","ูุนุฑู_ุงูุฏูุฑ","ูุนุฑู_ุงููุฑุน","ุฑูู_ุงููุงุชู","ุงููุฏููุฉ","ุงูุจูุฏ","ุงูุญุงูุฉ","ุงูุฌูุณ", "ุชุงุฑูุฎ_ุงูุฅูุดุงุก","ุขุฎุฑ_ุชุณุฌูู_ุฏุฎูู","ุฃูุดุฆ_ุจูุงุณุทุฉ","ุขุฎุฑ_ุชุญุฏูุซ", "ูุนุฑู_ุงูููุฏูุจ_ุงูููุญูู" ] },
    { name: "ุงูุฃุฏูุงุฑ", cols: ["ูุนุฑู_ุงูุฏูุฑ","ุงุณู_ุงูุฏูุฑ","ุงูุตูุงุญูุงุช_JSON","ุชุงุฑูุฎ_ุงูุฅูุดุงุก"] },
    { name: "ุงููุฑูุน", cols: ["ูุนุฑู_ุงููุฑุน","ุงุณู_ุงููุฑุน","ุงูุฏููุฉ","ุงููุฏููุฉ","ุงููุฏูุฑ_ุงููุณุคูู","ุงูุญุงูุฉ","ุชุงุฑูุฎ_ุงูุฅูุดุงุก"] },
    { name: "ุงูุจูุฏุงู_ุงูุนุฑุจูุฉ", cols: ["ูุนุฑู_ุงูุจูุฏ","ุงุณู_ุงูุจูุฏ","ุงูุฑูู_ุงูุฏููู","ุนุงุตูุฉ_ุงูุจูุฏ","ุงูุนููุฉ"], fill: setupArabCountries },
    { name: "ูุงุนุฏุฉ_ุงูุจูุงูุงุช_ุงูุทูุงุจ", cols: ["ูุนุฑู_ุงููุณุชุฎุฏู","ูุนุฑู_ุงูุฏูุฑุฉ","ูุนุฑู_ุงููุฌููุนุฉ","ูุนุฑู_ุงููุนูู","ุงุณู_ุงููุนูู","ุชุงุฑูุฎ_ุงูุชุณุฌูู","ุชุงุฑูุฎ_ุจุฏุงูุฉ_ุงูุฏูุฑุฉ","ุชุงุฑูุฎ_ููุงูุฉ_ุงูุฏูุฑุฉ","ุญุงูุฉ_ุงูุชุณุฌูู","ูุณุจุฉ_ุงูุฅูุฌุงุฒ","ุงูุชูููู_ุงูุนุงู","ุนุฏุฏ_ุงูุญุตุต_ุงููุฌุชุงุฒุฉ","ุนุฏุฏ_ุงูุญุตุต_ุงููุชุจููุฉ","ุขุฎุฑ_ุญุถูุฑ","ููุงุญุธุงุช_ุงููุนูู","ููุงุญุธุงุช_ุฅุฏุงุฑูุฉ","ุทุฑููุฉ_ุงูุฏูุน","ุญุงูุฉ_ุงูุฏูุน","ูููุฉ_ุงูุฏูุฑุฉ","ุงููุจูุบ_ุงููุฏููุน","ุงููุจูุบ_ุงููุชุจูู","ูุนุฑู_ุงูุฎุตู","ุงุณู_ุงููุณุชุฎุฏู","ุชุงุฑูุฎ_ุขุฎุฑ_ุชุญุฏูุซ"] }, 
    { name: "ุฅุฏุงุฑุฉ_ุงููุนูููู_ูุงูููุธููู", cols: ["ูุนุฑู_ุงููุณุชุฎุฏู","ุชุงุฑูุฎ_ุงููููุงุฏ","ุฑูู_ุงููููุฉ","ุงูุนููุงู","ุงูุชุฎุตุต","ุงููุณูู_ุงููุธููู","ุงููุคูู_ุงูุนููู","ุณููุงุช_ุงูุฎุจุฑุฉ","ุงูุดูุงุฏุงุช_ุงูููููุฉ","ุฑูู_ุงููุงุชู","ุฑูู_ูุงุชุณุงุจ","ุฑูู_ุทูุงุฑุฆ","ููุน_ุงูุนูุฏ","ุชุงุฑูุฎ_ุงูุชุนููู","ุชุงุฑูุฎ_ุจุฏุงูุฉ_ุงูุนูุฏ","ุชุงุฑูุฎ_ููุงูุฉ_ุงูุนูุฏ","ุนุฏุฏ_ุณุงุนุงุช_ุงูุนูู","ุงูุฏุฑุฌุฉ_ุงููุธูููุฉ","ุงูุญุงูุฉ_ุงููุธูููุฉ","ุงูุฑุงุชุจ_ุงูุฃุณุงุณู","ูุณุจุฉ_ุงูุญูุงูุฒ","ุงูุจุฏูุงุช","ุงูุฎุตููุงุช","ุฅุฌูุงูู_ุงูุฑุงุชุจ","ุทุฑููุฉ_ุงูุฏูุน","ุงููุดุฑู_ุงููุจุงุดุฑ","ุตูุงุญูุงุช_ุชูุตูููุฉ"] }, 
    { name: "ุจูุงูุงุช_ุงููุณูููู", cols: ["ูุนุฑู_ุงููุณุชุฎุฏู","ุงููุงุชู","ุงูุจุฑูุฏ_ุงูุฅููุชุฑููู_ุงูุงุญุชูุงุทู","ุนููุงู_ุงูุจุฑูุฏ_ุงูุงุญุชูุงุทู","ุฑูู_ูุงุชุณุงุจ","ุงููุฏููุฉ","ุชุงุฑูุฎ_ุงูุงูุถูุงู","ุขุฎุฑ_ูุดุงุท","ููุงุญุธุงุช_ุฅุฏุงุฑูุฉ","ููุน_ุงูููุฏูุจ","ูุณุชูู_ุงูุตูุงุญูุงุช","ุฅุฌูุงูู_ุงูุทูุงุจ","ุฅุฌูุงูู_ุงูุนูููุฉ","ุฅุฌูุงูู_ุงููุณุญูุจุงุช","ุฅุฌูุงูู_ุงูููุงูุขุช","ุงูุฑุตูุฏ_ุงูุญุงูู","ุนุฏุฏ_ุงูุฏูุฑุงุช_ุงููุณุฌูุฉ","ุชูููู_ุงูุฃุฏุงุก"] }, 
    { name: "ุงูุฏูุฑุงุช", cols: ["ูุนุฑู_ุงูุฏูุฑุฉ","ุงุณู_ุงูุฏูุฑุฉ","ุงููุตู","ุนุฏุฏ_ุงูุณุงุนุงุช","ุงูุณุนุฑ","ุงููุณุชูู","ููุน_ุงูุฏูุฑุฉ","ุงูุญุงูุฉ","ูุนุฑู_ุงููุฑุน","ุชุงุฑูุฎ_ุงูุฅูุดุงุก","ุฃูุดุฆ_ุจูุงุณุทุฉ"] },
    { name: "ุงููุฌููุนุงุช", cols: ["ูุนุฑู_ุงููุฌููุนุฉ","ูุนุฑู_ุงูุฏูุฑุฉ","ูุนุฑู_ุงููุนูู","ุฃูุงู_ุงูุฏุฑุงุณุฉ","ุชูููุช_ุงูุฏุฑุงุณุฉ","ุชุงุฑูุฎ_ุงูุจุฏุงูุฉ","ุชุงุฑูุฎ_ุงูููุงูุฉ","ุงูุญุงูุฉ","ุชุงุฑูุฎ_ุงูุฅูุดุงุก"] },
    { name: "ุชุณุฌููุงุช_ุงูุฏูุฑุงุช", cols: ["ูุนุฑู_ุงูุชุณุฌูู","ูุนุฑู_ุงููุณุชุฎุฏู","ูุนุฑู_ุงูุฏูุฑุฉ","ูุนุฑู_ุงููุฌููุนุฉ","ุชุงุฑูุฎ_ุงูุชุณุฌูู","ุญุงูุฉ_ุงูุชุณุฌูู","ูุนุฑู_ุงูุฎุตู","ูุนุฑู_ุงููุฑุน","ุฃูุดุฆ_ุจูุงุณุทุฉ","ุขุฎุฑ_ุชุญุฏูุซ"] },
    { name: "ุชูุฏู_ุงูุทุงูุจ", cols: ["ูุนุฑู_ุงูุชูุฏู","ูุนุฑู_ุงูุชุณุฌูู","ูุณุจุฉ_ุงูุฅูุฌุงุฒ","ุนุฏุฏ_ุงูุญุตุต_ุงููุฌุชุงุฒุฉ","ุนุฏุฏ_ุงูุญุตุต_ุงููุชุจููุฉ","ุขุฎุฑ_ุญุถูุฑ","ุงูุชูููู_ุงูุนุงู","ููุงุญุธุงุช_ุงููุนูู","ููุงุญุธุงุช_ุฅุฏุงุฑูุฉ","ุขุฎุฑ_ุชุญุฏูุซ"] },
    { name: "ููุงู_ุงูุทูุงุจ", cols: ["ูุนุฑู_ุงููููุฉ","ุงูุนููุงู","ุงููุตู","ููุน_ุงููููุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ูุนุฑู_ุงููุฌููุนุฉ","ูุนุฑู_ุงูุฏูุฑุฉ","ุงููุณุคูู_ุนู_ุงููููุฉ","ุชุงุฑูุฎ_ุงูุฅุณูุงุฏ","ุชุงุฑูุฎ_ุงูุงุณุชุญูุงู","ุญุงูุฉ_ุงููููุฉ","ุงูููุงุท","ุฃููููุฉ_ุงููููุฉ","ุทุฑููุฉ_ุงูุชุณููู","ูุฑููุงุช","ุชุฐููุฑ_ุชููุงุฆู","ุนุฏุฏ_ุงูุชูุจููุงุช_ุงููุฑุณูุฉ","ุขุฎุฑ_ุชุญุฏูุซ","ููุงุญุธุงุช_ุงูุฅุฏุงุฑุฉ","ูุฑุฆู_ููุทุงูุจ"] }, 
    { name: "ุชูููุฐ_ุงูููุงู_ูู_ุงูุทูุงุจ", cols: ["ูุนุฑู_ุงูุชูููุฐ","ูุนุฑู_ุงููููุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ูุนุฑู_ุงููุฌููุนุฉ","ูุนุฑู_ุงูุฏูุฑุฉ","ุชุงุฑูุฎ_ุงูุจุฏุงูุฉ","ุชุงุฑูุฎ_ุงูุชุณููู","ุญุงูุฉ_ุงูุชูููุฐ","ุงูููุงุท_ุงูููุชุณุจุฉ","ููุงุญุธุงุช_ุงููุนูู","ูุฑููุงุช_ุงูุทุงูุจ","ุนุฏุฏ_ูุญุงููุงุช_ุงูุชุณููู","ููุช_ุงูุฅููุงู","ุชูููู_ุงูุชุณููู","ุขุฎุฑ_ุชุญุฏูุซ","ูุฑุฆู_ููุทุงูุจ"] },
    { name: "ูุฏููุนุงุช_ุงูุชุณุฌูู", cols: ["ูุนุฑู_ุงูุฏูุน","ูุนุฑู_ุงูุชุณุฌูู","ูุนุฑู_ุงููุณุชุฎุฏู","ูุนุฑู_ุงูุฏูุฑุฉ","ุงููุจูุบ_ุงููุณุชุญู","ุงููุจูุบ_ุงููุฏููุน","ุงููุจูุบ_ุงููุชุจูู","ุทุฑููุฉ_ุงูุฏูุน","ุญุงูุฉ_ุงูุฏูุน","ุฑูู_ุงูุฅูุตุงู","ุชุงุฑูุฎ_ุงูุฏูุน","ูุนุฑู_ุงููุฑุน","ุฃูุดุฆ_ุจูุงุณุทุฉ","ุขุฎุฑ_ุชุญุฏูุซ"] },
    { name: "ุงูุฎุตููุงุช", cols: ["ูุนุฑู_ุงูุฎุตู","ููุฏ_ุงูุฎุตู","ููุน_ุงูุฎุตู","ูููุฉ_ุงูุฎุตู","ุชุงุฑูุฎ_ุงูุจุฏุงูุฉ","ุชุงุฑูุฎ_ุงูููุงูุฉ","ุนุฏุฏ_ุงูุงุณุชุฎุฏุงู","ุงูุญุงูุฉ","ุชุงุฑูุฎ_ุงูุฅูุดุงุก"] },
   { name: "ุงูุงุฎุชุจุงุฑุงุช", cols: ["ูุนุฑู_ุงูุงุฎุชุจุงุฑ","ุงุณู_ุงูุงุฎุชุจุงุฑ","ูุฏุฉ_ุงูุงุฎุชุจุงุฑ","ุฏุฑุฌุฉ_ุงููุฌุงุญ","ูุญุงููุงุช_ูุณููุญุฉ","ุชุฑุชูุจ_ุนุดูุงุฆู","ุงูุญุงูุฉ","ุชุงุฑูุฎ_ุงูุฅูุดุงุก"] },
    // ุฌุฏูู ูุณูุท ุดุงูู ูุฑุจุท ุงูุงุฎุชุจุงุฑุงุช ุจุงูุฏูุฑุงุช ูุงููุฌููุนุงุช ูุน ุฅุนุฏุงุฏุงุช ูุชูุฏูุฉ
  { name: "ุงููุญูุธุฉ_ุงููุงููุฉ", cols: ["ูุนุฑู_ุงููุญูุธุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ุงูุฑุตูุฏ_ุงูุญุงูู","ุฅุฌูุงูู_ุงูุฃุฑุจุงุญ","ุฅุฌูุงูู_ุงููุณุญูุจุงุช","ุขุฎุฑ_ุชุญุฏูุซ"] },
  { name: "ุณุฌู_ุงูุนูููุงุช_ุงููุงููุฉ", cols: ["ูุนุฑู_ุงูุนูููุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ุงูููุน","ุงููุจูุบ","ุงูุญุงูุฉ","ุงูุชุงุฑูุฎ","ููุงุญุธุงุช"] },
  { name: "ุณุฌู_ุงูุญุถูุฑ_ุงูุชูุตููู", cols: ["ูุนุฑู_ุงูุญุถูุฑ","ูุนุฑู_ุงููุฌููุนุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ุงูุชุงุฑูุฎ","ุงูุญุงูุฉ","ููุงุญุธุงุช_ุงููุนูู"] }, 

{ 
  name: "ุฑุจุท_ุงูุงุฎุชุจุงุฑุงุช_ุจุงูุฏูุฑุงุช_ูุงููุฌููุนุงุช", 
  cols: [
    "ูุนุฑู_ุงูุงุฎุชุจุงุฑ",       // ูุฑุจุท ุจุงูุฌุฏูู "ุงูุงุฎุชุจุงุฑุงุช"
    "ูุนุฑู_ุงูุฏูุฑุฉ",          // ูุฑุจุท ุจุงูุฌุฏูู "ุงูุฏูุฑุงุช"
    "ูุนุฑู_ุงููุฌููุนุฉ",        // ูุฑุจุท ุจุงูุฌุฏูู "ุงููุฌููุนุงุช"
    "ููุช_ุงูุงุฎุชุจุงุฑ_ูู",      // ููุช ุจุฏุก ุงูุงุฎุชุจุงุฑ (ุงุฎุชูุงุฑู)
    "ููุช_ุงูุงุฎุชุจุงุฑ_ุงูู",     // ููุช ุงูุชูุงุก ุงูุงุฎุชุจุงุฑ (ุงุฎุชูุงุฑู)
    "ุงูุญุงูุฉ",                // ูุชูุนูู/ุชุนุทูู ุงูุงุฎุชุจุงุฑ ููุฌููุนุฉ ูุนููุฉ (ูุดุท/ุบูุฑ ูุดุท)
    "ุญุฏ_ุงููุญุงููุงุช",          // ุนุฏุฏ ุงููุญุงููุงุช ุงููุณููุญุฉ ููุฐู ุงููุฌููุนุฉ (ูููู ุชุฑูู ูุงุฑุบ ููุนุงู)
    "ุงูุฏุฑุฌุฉ_ุงููุตูู",          // ุงูุญุฏ ุงูุฃูุตู ููุฏุฑุฌุฉ ููู ูุฌููุนุฉ (ุงุฎุชูุงุฑู)
    "ููุงุญุธุงุช_ุฅุฏุงุฑูุฉ"         // ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจุงูุฅุฏุงุฑุฉ ููุฐู ุงูุนูุงูุฉ
  ] 
},
    { 
  name: "ุจูู_ุงูุฃุณุฆูุฉ", 
  cols: [
    "ูุนุฑู_ุงูุณุคุงู",          // ูุนุฑู ูุฑูุฏ ููู ุณุคุงู
    "ูุต_ุงูุณุคุงู",            // ูุต ุงูุณุคุงู
    "ุงูุฎูุงุฑ_A",             // ุงูุฎูุงุฑ ุฃ
    "ุงูุฎูุงุฑ_B",             // ุงูุฎูุงุฑ ุจ
    "ุงูุฎูุงุฑ_C",             // ุงูุฎูุงุฑ ุฌ
    "ุงูุฅุฌุงุจุฉ_ุงูุตุญูุญุฉ",      // ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (A/B/C)
    "ุงูุฏุฑุฌุฉ",               // ุงูุฏุฑุฌุฉ ุงููุฎุตุตุฉ ููุณุคุงู
    "ูุณุชูู_ุงูุตุนูุจุฉ",        // ุตุนูุจุฉ ุงูุณุคุงู (ุณูู/ูุชูุณุท/ุตุนุจ)
    "ุดุฑุญ_ุงูุฅุฌุงุจุฉ",          // ุดุฑุญ ููุฅุฌุงุจุฉ (ุงุฎุชูุงุฑู)
    "ุงูุญุงูุฉ",               // ูุชูุนูู/ุชุนุทูู ุงูุณุคุงู (ูุดุท/ุบูุฑ ูุดุท)
    "ุชุงุฑูุฎ_ุงูุฅุถุงูุฉ"          // ุชุงุฑูุฎ ุฅุถุงูุฉ ุงูุณุคุงู
  ],
  // ููุงุญุธุงุช ุญูู ุงูุฑุจุท:
  // 1. ุงูุนูุงูุฉ ุจูู ุงูุณุคุงู ูุงูุฏูุฑุฉ ุชุชู ูู ุฎูุงู "ูุนุฑู_ุงูุฏูุฑุฉ" ุงูููุฌูุฏ ูู ุฌุฏูู ุงูุงุฎุชุจุงุฑ ุนูุฏ ุฑุจุท ุงูุงุฎุชุจุงุฑุงุช ุจุงูุฏูุฑุงุช.
  // 2. ุงูุนูุงูุฉ ุจูู ุงูุณุคุงู ูุงูุงุฎุชุจุงุฑ ุชุชู ุนุจุฑ ุฌุฏูู "ุงุฎุชุจุงุฑ_ุฃุณุฆูุฉ" ุงูุฐู ูุญุชูู "ูุนุฑู_ุงูุณุคุงู" ู "ูุนุฑู_ุงูุงุฎุชุจุงุฑ".
  // 3. ุงูุนูุงูุฉ ุจูู ุงูุงุฎุชุจุงุฑ ูุงูุฏูุฑุฉ ูุงููุฌููุนุฉ ุชุชู ุนุจุฑ ุฌุฏูู "ุฑุจุท_ุงูุงุฎุชุจุงุฑุงุช_ุจุงูุฏูุฑุงุช_ูุงููุฌููุนุงุช".
  // ุจูุฐู ุงูุทุฑููุฉ ูููู ุงุณุชุฎุฏุงู ููุณ ุงูุณุคุงู ูู ุงุฎุชุจุงุฑุงุช ูุชุนุฏุฏุฉ ูุฏูุฑุงุช ูุชุนุฏุฏุฉ ููุฌููุนุงุช ูุชุนุฏุฏุฉ ุฏูู ุชูุฑุงุฑ ุงูุณุคุงู ููุณู.
}, 
    { name: "ุงุฎุชุจุงุฑ_ุฃุณุฆูุฉ", cols: ["ูุนุฑู_ุงูุฑุจุท","ูุนุฑู_ุงูุงุฎุชุจุงุฑ","ูุนุฑู_ุงูุณุคุงู","ุชุฑุชูุจ_ุงูุณุคุงู"] },
    { 
  name: "ุฅุฌุงุจุงุช_ุงูุทูุงุจ", 
  cols: [
    "ูุนุฑู_ุฅุฌุงุจุฉ",         // ูุนุฑู ูุฑูุฏ ููู ุณุฌู ุฅุฌุงุจุฉ
    "ูุนุฑู_ุงููุชูุฌุฉ",        // ูุฑุจุท ุจุงูุฌุฏูู "ูุชุงุฆุฌ_ุงูุงุฎุชุจุงุฑุงุช"
    "ูุนุฑู_ุงูุณุคุงู",         // ูุฑุจุท ุจุงูุฌุฏูู "ุจูู_ุงูุฃุณุฆูุฉ"
    "ุงูุฅุฌุงุจุฉ_ุงูููุฏูุฉ",     // ุงูุฅุฌุงุจุฉ ุงูุชู ุฃุฏุฎููุง ุงูุทุงูุจ
    "ุญุงูุฉ_ุงูุฅุฌุงุจุฉ",        // ุตุญูุญุฉ / ุฎุงุทุฆุฉ / ูู ุชุฌุจ
    "ุฏุฑุฌุฉ_ุงูุฅุฌุงุจุฉ"         // ุงูุฏุฑุฌุฉ ุงูููููุญุฉ ููุฐุง ุงูุณุคุงู
  ]
}, 
    { name: "ูุชุงุฆุฌ_ุงูุงุฎุชุจุงุฑุงุช", cols: ["ูุนุฑู_ุงููุชูุฌุฉ","ูุนุฑู_ุงูุงุฎุชุจุงุฑ","ูุนุฑู_ุงููุณุชุฎุฏู","ุงูุฏุฑุฌุฉ","ุงููุณุจุฉ_ุงููุฆููุฉ","ุญุงูุฉ_ุงููุฌุงุญ","ุชุงุฑูุฎ_ุงูุงุฎุชุจุงุฑ"] },
    { name: "ุงูุดูุงุฏุงุช", cols: ["ูุนุฑู_ุงูุดูุงุฏุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ูุนุฑู_ุงูุฏูุฑุฉ","ุชุงุฑูุฎ_ุงูุฅุตุฏุงุฑ","ูุณุจุฉ_ุงููุฌุงุญ","ุฑุงุจุท_ุงูุดูุงุฏุฉ","ุฑูู_ุงูุชุญูู","ุงูุญุงูุฉ"] },
    { name: "ูููุงุช_ุงูุดุงุช", cols: ["ูุนุฑู_ุงูููุงุฉ","ุงุณู_ุงูููุงุฉ","ููุน_ุงูููุงุฉ","ูุนุฑู_ุงููุงูู","ูุนุฑู_ุงูุฏูุฑุฉ","ูุตู_ุงูููุงุฉ","ูุณุชูู_ุงูุฎุตูุตูุฉ","ุตูุฑุฉ_ุงูููุงุฉ","ุงูุญุงูุฉ","ุชุงุฑูุฎ_ุงูุฅูุดุงุก","ุขุฎุฑ_ุชุญุฏูุซ"] },
    { name: "ุฃุนุถุงุก_ุงููููุงุช", cols: ["ูุนุฑู_ุงูุนุถููุฉ","ูุนุฑู_ุงูููุงุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ุงูุฏูุฑ_ุฏุงุฎู_ุงูููุงุฉ","ุญุงูุฉ_ุงูุนุถููุฉ","ุชุงุฑูุฎ_ุงูุงูุถูุงู","ุชุงุฑูุฎ_ุงูุฎุฑูุฌ","ุขุฎุฑ_ูุดุงุท","ููุงุญุธุงุช"] },
    { name: "ุฑุณุงุฆู_ุงูุดุงุช", cols: ["ูุนุฑู_ุงูุฑุณุงูุฉ","ูุนุฑู_ุงูููุงุฉ","ูุนุฑู_ุงููุฑุณู","ุงููุญุชูู","ููุน_ุงูุฑุณุงูุฉ","ุฑุฏ_ุนูู","ุชุงุฑูุฎ_ุงูุฅุฑุณุงู","ุชู_ุงูุชุนุฏูู","ุชู_ุงูุญุฐู"] },
    { name: "ูุฑููุงุช_ุงูุฑุณุงุฆู", cols: ["ูุนุฑู_ุงููุฑูู","ูุนุฑู_ุงูุฑุณุงูุฉ","ุงูุฑุงุจุท","ุงูููุน","ุงูุญุฌู","ุชุงุฑูุฎ_ุงูุฑูุน"] },
    { name: "ุชุซุจูุช_ุงูุฑุณุงุฆู", cols: ["ูุนุฑู_ุงูุชุซุจูุช","ูุนุฑู_ุงูููุงุฉ","ูุนุฑู_ุงูุฑุณุงูุฉ","ุซุจุช_ุจูุงุณุทุฉ","ุชุงุฑูุฎ_ุงูุชุซุจูุช"] },
    { name: "ูุญุงุฏุซุงุช_ุงูุจุฑูุฏ", cols: ["ูุนุฑู_ุงููุญุงุฏุซุฉ","ุงูุนููุงู","ุฃูุดุฆุช_ุจูุงุณุทุฉ","ููุน_ุงููุญุงุฏุซุฉ","ุงูุญุงูุฉ","ุชุงุฑูุฎ_ุงูุฅูุดุงุก","ุขุฎุฑ_ุชุญุฏูุซ"] },
    { name: "ุฑุณุงุฆู_ุงูุจุฑูุฏ", cols: ["ูุนุฑู_ุงูุฑุณุงูุฉ","ูุนุฑู_ุงููุญุงุฏุซุฉ","ูุนุฑู_ุงููุฑุณู","ุงููุญุชูู","ุฑุฏ_ุนูู","ุชุงุฑูุฎ_ุงูุฅุฑุณุงู","ุชุงุฑูุฎ_ุงูุชุนุฏูู","ุชุงุฑูุฎ_ุงูุญุฐู"] },
    { name: "ูุณุชููู_ุงููุญุงุฏุซุงุช", cols: ["ูุนุฑู_ุงูุฑุจุท","ูุนุฑู_ุงููุญุงุฏุซุฉ","ูุนุฑู_ุงููุณุชุฎุฏู","ุญุงูุฉ_ุงููุฑุงุกุฉ","ููู","ุชุงุฑูุฎ_ุงููุฑุงุกุฉ"] },
    { name: "ุณุฌู_ุงููุดุงุทุงุช", cols: ["ูุนุฑู_ุงูุณุฌู","ูุนุฑู_ุงููุณุชุฎุฏู","ููุน_ุงูุนูููุฉ","ุงูููุงู_ุงููุชุฃุซุฑ","ูุนุฑู_ุงูููุงู","ุงูุชุงุฑูุฎ","IP","ููุงุญุธุงุช"] },
    { name: "ุณุฌู_ุงูุฃุฎุทุงุก", cols: ["ูุนุฑู_ุงูุฎุทุฃ","ุงููุตุฏุฑ","ุงูุฑุณุงูุฉ","ุงูุจูุงูุงุช","ุงูุชุงุฑูุฎ","ุชู_ุงูุญู"] },
    { name: "ูุงุนุฏุฉ_ุงูุณูุฑ", cols: ["ููุฏ ุงูุณูุฑุฉ", "ุงุณู ุงูุณูุฑุฉ", "ุนุฏุฏ ุงูุขูุงุช", "ุงููุตุญู"], fill: fillSurahData }
  ];

  // ุฅูุดุงุก ุฌููุน ุงูุฌุฏุงูู ูุชุนุจุฆุชูุง ุนูุฏ ุงูุญุงุฌุฉ
  tables.forEach(function(table) {
    createOrUpdateSheet(ss, table.name, table.cols, table.fill);
  });

  SpreadsheetApp.getUi().alert("โ ุชู ุชุฃุณูุณ ุงููุธุงู ุงููุงูู ุจูุฌุงุญ!");
}

// =================== ุฅูุดุงุก ุฃู ูุณุญ ุงููุฑูุฉ ูุชุนุจุฆุชูุง ===================
function createOrUpdateSheet(ss, sheetName, headers, fillFunc) {
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
  } else {
    sheet.clearContents();
  }
  sheet.getRange(1,1,1,headers.length).setValues([headers]);
  formatHeader(sheet);
  if (fillFunc) fillFunc(sheet);
}

// =================== ุชูุณูู ุงูุตู ุงูุฃูู ===================
function formatHeader(sheet) {
  var range = sheet.getRange(1, 1, 1, sheet.getLastColumn());
  range.setBackground("#202124")
       .setFontColor("#ffffff")
       .setFontWeight("bold")
       .setHorizontalAlignment("center");
  sheet.setFrozenRows(1);
}

// =================== ุชุนุจุฆุฉ ุงูุฅุนุฏุงุฏุงุช ุงูุฃุณุงุณูุฉ ===================
function fillSettings(sheet) {
  var settingsData = [
     ["API_KEY", "KANANT-2026", "ููุชุงุญ ุงูุฃูุงู ููุฑุจุท ูุน ุงูุชุทุจูู"],
  ["ACADEMY_NAME", "ุฃูุงุฏูููุฉ ูู ุฃูุช ููุชุฏุฑูุจ ูุงูุชุฃููู", "ุงูุงุณู ุงูุฑุณูู ููุฌูุฉ"],
  ["CURRENT_TERM", "ุงููุตู ุงูุฏุฑุงุณู ุงูุซุงูู", "ูุณุชุฎุฏู ูู ูุฑุฒ ุงููุชุงุฆุฌ"],
  ["MIN_PASS_GRADE", "60", "ุฏุฑุฌุฉ ุงููุฌุงุญ ุงูุฏููุง ูู ุงูุดูุงุฏุงุช"],
  ["ATTENDANCE_LIMIT", "15", "ููุช ุงูุณูุงุญ ุจุงูุชุฃุฎุฑ (ุจุงูุฏูุงุฆู)"],
  ["SYSTEM_LANGUAGE", "ar", "ูุบุฉ ุงููุธุงู ุงูุงูุชุฑุงุถูุฉ"],
  ["DATE_FORMAT", "yyyy-MM-dd HH:mm", "ุชูุณูู ุงูุชุงุฑูุฎ ุงูููุญุฏ ูู ุงููุธุงู"],
  ["TIME_FORMAT", "HH:mm", "ุตูุบุฉ ุนุฑุถ ุงูููุช (HH:mm)"],
  ["LOW_EVALUATION_LIMIT", "5", "ุงูุญุฏ ุงูุฃุฏูู ููุชูููู ูุจู ุฅูุดุงุก ุฅุดุนุงุฑ"],


  // ๐ ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
  ["NOTIFICATIONS_STATUS", "ูุดุท", "ุชุดุบูู ุฃู ุฅููุงู ูุธุงู ุงูุฅุดุนุงุฑุงุช"],
  ["DEFAULT_NOTIFICATION_CHANNEL", "internal", "ุงูููุงุฉ ุงูุงูุชุฑุงุถูุฉ ููุฅุดุนุงุฑุงุช"],
  ["NOTIFICATION_EXPIRY_DAYS", "30", "ุนุฏุฏ ุงูุฃูุงู ูุจู ุฃุฑุดูุฉ ุงูุฅุดุนุงุฑ ุชููุงุฆูุงู"],
  ["Notification_Sound", "true", "ุชุดุบูู ุตูุช ุงูุชูุจูู ููุฅุดุนุงุฑุงุช"],
  ["Notification_Priority", "High", "ุฏุฑุฌุฉ ุฃููููุฉ ุงูุฅุดุนุงุฑุงุช (High/Medium/Low)"],

  // ๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
  ["SYSTEM_ADMIN", "be.you.t2025@gmail.com", "ุจุฑูุฏ ูุณุคูู ุงููุธุงู"],
  ["EMAIL_API_KEY", "XYZ-1234-TEST", "ููุชุงุญ API ูุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"],
  ["EMAIL_SIGNATURE", "ุฃูุงุฏูููุฉ ูู ุฃูุช ููุชุฏุฑูุจ ูุงูุชุฃููู", "ุชูููุน ุงูุฑุณุงุฆู ูุงูุฅุดุนุงุฑุงุช"],
  ["EMAIL_TEMPLATE_ATTENDANCE", "template_att_01", "ูุงูุจ ุฑุณุงุฆู ุงูุญุถูุฑ ูุงูุบูุงุจ"],
  ["EMAIL_TEMPLATE_NOTIFICATION", "template_notif_01", "ูุงูุจ ุฑุณุงุฆู ุงูุฅุดุนุงุฑุงุช ุงูุนุงูุฉ"],
  ["SEND_INDIVIDUAL", "true", "ุฅุฑุณุงู ุงูุจุฑูุฏ ูุฑุฏู (true) ุฃู ุฌูุงุนู (false)"],

  // โ๏ธ ุงููุธุงู ูุงูุชุดุบูู
  ["TEST_MODE", "false", "ูุถุน ุงูุงุฎุชุจุงุฑ (true = ุจุฏูู ุฅุฑุณุงู ูุนูู)"],
  ["SYSTEM_STATUS", "ูุดุท", "ุฅููุงู ุงููุธุงู ูุคูุชุงู ูุฃุนูุงู ุงูุตูุงูุฉ"],
  ["DEFAULT_SHEET", "MasterData", "ุงููุฑูุฉ ุงูุงูุชุฑุงุถูุฉ ููุจูุงูุงุช"],
  ["Backup_Enabled", "true", "ูุณุฎ ุงุญุชูุงุทู ุชููุงุฆู ููุจูุงูุงุช"],
  ["Auto_Archive", "true", "ุฃุฑุดูุฉ ุชููุงุฆูุฉ ููุจูุงูุงุช"],
  ["DELEGATE_COMMISSION_PERCENT", "10%", "ูุณุจุฉ ุนูููุฉ ุงูููุฏูุจ "],   ["TEACHER_HOUR_RATE", "5", "ุณุนุฑ ุงูุณุงุนุฉ ูููุนูู"],
  ["WITHDRAWAL_MIN_LIMIT", "50", "ุงูุญุฏ ุงูุงุฏูู ููุณุญุจ"],
  // ๐ ุงูุญุถูุฑ ูุงูุบูุงุจ
  ["ACADEMY_LOGO", "https://drive.google.com/file/d/1136iAKx_Y2GLc45zBx1q09-rMWX4rXI9/view?usp=drivesdk", "ุดุนุงุฑ ุงููุคุณุณุฉ"],
  ["PLATFORM_URL", "https://kanantacademy.com", "ุฑุงุจุท ุงูููุตุฉ ุงูุฅููุชุฑูููุฉ"],
  ["ABSENCE_ALERT_LIMIT", "5", "ุงูุบูุงุจ ุงููุณููุญ ุจู ูุจู ุฅุฑุณุงู ุฅุดุนุงุฑ"],
  ["Attendance_Sheet", "AttendanceLog", "ุงุณู ูุฑูุฉ ุณุฌู ุงูุญุถูุฑ"],
  ["Auto_Calc_Attendance", "true", "ุญุณุงุจ ุงูุญุถูุฑ ุชููุงุฆูุงู (true / false)"],

  // ๐ ุงูุชุญูู ูุงูุชูุงุฑูุฑ
  ["Error_Log_Sheet", "ErrorLog", "ูุฑูุฉ ูุชุณุฌูู ุงูุฃุฎุทุงุก"],
  ["Notification_Sheet", "NotificationLog", "ูุฑูุฉ ุงูุฅุดุนุงุฑุงุช"],
  ["Report_Generation", "true", "ุชูููุฏ ุชูุงุฑูุฑ ุชููุงุฆูุงู (true / false)"],
  ["Report_Format", "PDF", "ุชูุณูู ุงูุชูุงุฑูุฑ (PDF / Excel / HTML)"],
  ["Max_Login_Attempts", "5", "ุงูุญุฏ ุงูุฃูุตู ููุญุงููุงุช ุชุณุฌูู ุงูุฏุฎูู"],

  // ๐ ุฅุถุงููุฉ
  ["Default_Password", "Kanant@123", "ูููุฉ ุงููุฑูุฑ ุงูุงูุชุฑุงุถูุฉ ูููุณุชุฎุฏููู ุงูุฌุฏุฏ"],
  ["Theme_Color", "#1E90FF", "ููู ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุฑุฆูุณู"],
  ["Support_Contact", "967778185189", "ุฑูู ุงูุฏุนู ุงูููู"],
  ["Terms_And_Conditions_URL", "https://kanantacademy.com/terms", "ุฑุงุจุท ุงูุดุฑูุท ูุงูุฃุญูุงู"],
  ["Privacy_Policy_URL", "https://kanantacademy.com/privacy", "ุฑุงุจุท ุณูุงุณุฉ ุงูุฎุตูุตูุฉ"],

  // ๐ ุฃูุงู ูุชุณุฌูู ุฏุฎูู
  ["Password_Policy", "min8+upper+number", "ุณูุงุณุฉ ูููุงุช ุงููุฑูุฑ (ุญุฏ ุฃุฏูู 8 ุญุฑููุ ุญุฑู ูุจูุฑุ ุฑูู)"],
  ["Two_Factor_Auth", "true", "ุชูุนูู ุงููุตุงุฏูุฉ ุงูุซูุงุฆูุฉ"],
  ["Session_Timeout", "30", "ูุฏุฉ ุงูุชูุงุก ุงูุฌูุณุฉ ุจุงูุฏูุงุฆู"],

  // โ๏ธ ุชูุจููุงุช ุฅุถุงููุฉ
  ["Low_Attendance_Alert", "true", "ุชูุจูู ุนูุฏ ุงูุฎูุงุถ ูุณุจุฉ ุงูุญุถูุฑ"],
  ["Overdue_Task_Alert", "true", "ุชูุจูู ุนูุฏ ููุงู ูุชุฃุฎุฑุฉ"],

  // ๐ ุชูุงุฑูุฑ ูุชูุฏูุฉ
  ["Report_Recipients", "admin@kanantacademy.com", "ูุงุฆูุฉ ุจุฑูุฏูุฉ ูุชููู ุงูุชูุงุฑูุฑ"],
  ["Report_Schedule", "weekly", "ุฌุฏูู ุชูููุช ุชูููุฏ ุงูุชูุงุฑูุฑ (daily/weekly/monthly)"],
  ["Enable_Analytics", "true", "ุชูุนูู ุฌูุน ุงูุฅุญุตุงุฆูุงุช ูุงูุฃุฏุงุก"],
  ["Analytics_Report_Sheet", "AnalyticsLog", "ูุฑูุฉ ูุชุฎุฒูู ุจูุงูุงุช ุงูุชุญููู ูุงูุฅุญุตุงุกุงุช"],

  // ๐จ ุชุฎุตูุต ูุงุฌูุฉ ุงููุณุชุฎุฏู
  ["Default_Language_UI", "ar", "ูุบุฉ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงูุงูุชุฑุงุถูุฉ"],
  ["Enable_Dark_Mode", "false", "ุชูุนูู ุงููุถุน ุงููููู"],
  ["Homepage_Message", "ูุฑุญุจุง ุจู ูู ุฃูุงุฏูููุฉ ูู ุฃูุช!", "ุฑุณุงูุฉ ุชุฑุญูุจ ุนูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ"],
  ["Custom_CSS", "custom_style.css", "ููู CSS ูุฎุตุต ูุชุบููุฑ ุณุชุงูู ุงููุธุงู"],
  ["Custom_JS", "custom_script.js", "ููู JS ูุฎุตุต ูุชุนุฏููุงุช ุงููุธุงู"],

  // ๐ ุงูุฑุจุท ุงูุฎุงุฑุฌู
  ["Integration_Portal_URL", "https://externalportal.com", "ุฑุงุจุท ุชูุงูู ุงูููุตุงุช ุงูุฃุฎุฑู"],
  ["External_API_Endpoints", "api/v1/getData", "ูุงุฆูุฉ ููุงุท ุงูููุงูุฉ ุงูุฎุงุฑุฌูุฉ"],
  ["ุฑุงุจุท_ุตูุญุฉ_ุงูุชุญูู", "ุถุน ููุง ุฑุงุจุท ุตูุฎุฉ ุงูุชุญูู", "ุฑุจุท ุตูุญุฉ ุงูุชุญูู"],
  // ๐พ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุชุฎุฒูู
  ["Backup_Frequency", "daily", "ุชูุงุชุฑ ุงููุณุฎ ุงูุงุญุชูุงุทู (daily/weekly/monthly)"],
  ["Backup_Location", "DriveFolderID_123456", "ูููุน ุชุฎุฒูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ"],
  ["Data_Retention_Days", "365", "ูุฏุฉ ุงูุงุญุชูุงุธ ุจุงูุจูุงูุงุช ูุจู ุงูุฃุฑุดูุฉ"],
  ["FLOATING_WHATSAPP", "967777612552", "ุฒุฑ ูุชุณุงุจ ุงูุนุงุฆู"],
  // ๐ ุฅุนุฏุงุฏุงุช ุงููุบุฉ ุงููุชุนุฏุฏุฉ
  ["Supported_Languages", "ar,en,fr", "ูุงุฆูุฉ ุงููุบุงุช ุงููุฏุนููุฉ ูููุธุงู"], 
  ["FOLDER_ID", "FOLDER_ID", "ูุนุฑู ูุฌูุฏ ุงูุชุฎุฒูู ุงูุฎุงุต ุจุงูุดูุงุฏุงุช "], 
  ["TEMPLATE_ID", "TEMPLATE_ID", "ูุนุฑู ูุงูุจ ุงูุดูุงุฏุฉ"], 
  //ุฃุณูุงุก ุงูุตูุญุงุช ุงูุงุณุงุณูุฉ
  ["CVP", "CVP.html", "ุฑุงุจุท ุตูุญุฉ ุงูุชุญูู ูู ุงูุดูุงุฏุงุช "], 
  ["VISITO_PAGE", "Visitor.html", "ุงุณู ุตูุญุฉ ุงูุฒุงุฆุฑ"],
 ["TEACHER_PAGE", "Teacher.html", "ุงุณู ุตูุญุฉ ุงููุนูู"],
 ["ADMIN_PAGE", "Admin.html", "ุงุณู ุตูุญุฉ ุงููุดุฑู"],
 ["SYSTEM_MANAGER", "System.html", "ุงุณู ุตูุญุฉ ูุฏูุฑ ุงููุธุงู"],
 ["DELEGATE_PAGE", "Delegate.html", "ุงุณู ุตูุญุฉ ุงูููุฏูุจ"] 

];
  if(sheet.getLastRow() === 1) {
    sheet.getRange(2, 1, settingsData.length, settingsData[0].length).setValues(settingsData);
  }
}

// =================== ุชุนุจุฆุฉ ุงูุจูุฏุงู ุงูุนุฑุจูุฉ ===================
function setupArabCountries(sheet) {
var countriesData = [
  ["CNT-00000001","ุงูุณุนูุฏูุฉ","966","ุงูุฑูุงุถ","ุฑูุงู"],
  ["CNT-00000002","ูุตุฑ","20","ุงููุงูุฑุฉ","ุฌููู"],
  ["CNT-00000003","ุงูุฅูุงุฑุงุช","971","ุฃุจูุธุจู","ุฏุฑูู"],
  ["CNT-00000004","ุงููููุช","965","ุงููููุช","ุฏููุงุฑ"],
  ["CNT-00000005","ูุทุฑ","974","ุงูุฏูุญุฉ","ุฑูุงู"],
  ["CNT-00000006","ุงูุจุญุฑูู","973","ุงูููุงูุฉ","ุฏููุงุฑ"],
  ["CNT-00000007","ุนููุงู","968","ูุณูุท","ุฑูุงู"],
  ["CNT-00000008","ุงูููู","967","ุตูุนุงุก","ุฑูุงู"],
  ["CNT-00000009","ุงูุฃุฑุฏู","962","ุนูุงู","ุฏููุงุฑ"],
  ["CNT-00000010","ููุณุทูู","970","ุงููุฏุณ","ุดููู"],
  ["CNT-00000011","ูุจูุงู","961","ุจูุฑูุช","ููุฑุฉ"],
  ["CNT-00000012","ุณูุฑูุง","963","ุฏูุดู","ููุฑุฉ"],
  ["CNT-00000013","ุงูุนุฑุงู","964","ุจุบุฏุงุฏ","ุฏููุงุฑ"],
  ["CNT-00000014","ููุจูุง","218","ุทุฑุงุจูุณ","ุฏููุงุฑ"],
  ["CNT-00000015","ุชููุณ","216","ุชููุณ","ุฏููุงุฑ"],
  ["CNT-00000016","ุงูุฌุฒุงุฆุฑ","213","ุงูุฌุฒุงุฆุฑ","ุฏููุงุฑ"],
  ["CNT-00000017","ุงููุบุฑุจ","212","ุงูุฑุจุงุท","ุฏุฑูู"],
  ["CNT-00000018","ููุฑูุชุงููุง","222","ููุงูุดูุท","ุฃูููุฉ"],
  ["CNT-00000019","ุงูุณูุฏุงู","249","ุงูุฎุฑุทูู","ุฌููู"],
  ["CNT-00000020","ุงูุตููุงู","252","ููุฏูุดู","ุดูู"],
  ["CNT-00000021","ุฌูุจูุชู","253","ุฌูุจูุชู","ูุฑูู"],
  ["CNT-00000022","ุฌุฒุฑ ุงูููุฑ","269","ููุฑููู","ูุฑูู"]
];


  var existingIds = [];
  if (sheet.getLastRow() > 1) {
    existingIds = sheet.getRange(2,1,sheet.getLastRow()-1,1).getValues().flat();
  }

  var newRows = countriesData.filter(r => !existingIds.includes(r[0]));
  if(newRows.length) newRows.forEach(row => sheet.appendRow(row));
}

// =================== ุชุนุจุฆุฉ ุณูุฑ ุงููุฑุขู ===================
function fillSurahData(sheet) {
  var ss = getMasterSS();
  if(!sheet) sheet = ss.getSheetByName("ูุงุนุฏุฉ_ุงูุณูุฑ");

var surahs = [
    ["1","ุงููุงุชุญุฉ","7","ููู"], ["2","ุงูุจูุฑุฉ","286","ูุฏูู"], ["3","ุขู ุนูุฑุงู","200","ูุฏูู"], ["4","ุงููุณุงุก","176","ูุฏูู"], ["5","ุงููุงุฆุฏุฉ","120","ูุฏูู"], 
    ["6","ุงูุฃูุนุงู","165","ููู"], ["7","ุงูุฃุนุฑุงู","206","ููู"], ["8","ุงูุฃููุงู","75","ูุฏูู"], ["9","ุงูุชูุจุฉ","129","ูุฏูู"], ["10","ูููุณ","109","ููู"],
    ["11","ููุฏ","123","ููู"], ["12","ููุณู","111","ููู"], ["13","ุงูุฑุนุฏ","43","ูุฏูู"], ["14","ุฅุจุฑุงููู","52","ููู"], ["15","ุงูุญุฌุฑ","99","ููู"], 
    ["16","ุงููุญู","128","ููู"], ["17","ุงูุฅุณุฑุงุก","111","ููู"], ["18","ุงูููู","110","ููู"], ["19","ูุฑูู","98","ููู"], ["20","ุทู","135","ููู"],
    ["21","ุงูุฃูุจูุงุก","112","ููู"], ["22","ุงูุญุฌ","78","ูุฏูู"], ["23","ุงููุคูููู","118","ููู"], ["24","ุงูููุฑ","64","ูุฏูู"], ["25","ุงููุฑูุงู","77","ููู"],
    ["26","ุงูุดุนุฑุงุก","227","ููู"], ["27","ุงูููู","93","ููู"], ["28","ุงููุตุต","88","ููู"], ["29","ุงูุนููุจูุช","69","ููู"], ["30","ุงูุฑูู","60","ููู"],
    ["31","ูููุงู","34","ููู"], ["32","ุงูุณุฌุฏุฉ","30","ููู"], ["33","ุงูุฃุญุฒุงุจ","73","ูุฏูู"], ["34","ุณุจุฃ","54","ููู"], ["35","ูุงุทุฑ","45","ููู"],
    ["36","ูุณ","83","ููู"], ["37","ุงูุตุงูุงุช","182","ููู"], ["38","ุต","88","ููู"], ["39","ุงูุฒูุฑ","75","ููู"], ["40","ุบุงูุฑ","85","ููู"],
    ["41","ูุตูุช","54","ููู"], ["42","ุงูุดูุฑู","53","ููู"], ["43","ุงูุฒุฎุฑู","89","ููู"], ["44","ุงูุฏุฎุงู","59","ููู"], ["45","ุงูุฌุงุซูุฉ","37","ููู"],
    ["46","ุงูุฃุญูุงู","35","ููู"], ["47","ูุญูุฏ","38","ูุฏูู"], ["48","ุงููุชุญ","29","ูุฏูู"], ["49","ุงูุญุฌุฑุงุช","18","ูุฏูู"], ["50","ู","45","ููู"],
    ["51","ุงูุฐุงุฑูุงุช","60","ููู"], ["52","ุงูุทูุฑ","49","ููู"], ["53","ุงููุฌู","62","ููู"], ["54","ุงูููุฑ","55","ููู"], ["55","ุงูุฑุญูู","78","ูุฏูู"],
    ["56","ุงููุงูุนุฉ","96","ููู"], ["57","ุงูุญุฏูุฏ","29","ูุฏูู"], ["58","ุงููุฌุงุฏูุฉ","22","ูุฏูู"], ["59","ุงูุญุดุฑ","24","ูุฏูู"], ["60","ุงูููุชุญูุฉ","13","ูุฏูู"],
    ["61","ุงูุตู","14","ูุฏูู"], ["62","ุงูุฌูุนุฉ","11","ูุฏูู"], ["63","ุงูููุงูููู","11","ูุฏูู"], ["64","ุงูุชุบุงุจู","18","ูุฏูู"], ["65","ุงูุทูุงู","12","ูุฏูู"],
    ["66","ุงูุชุญุฑูู","12","ูุฏูู"], ["67","ุงูููู","30","ููู"], ["68","ุงูููู","52","ููู"], ["69","ุงูุญุงูุฉ","52","ููู"], ["70","ุงููุนุงุฑุฌ","44","ููู"],
    ["71","ููุญ","28","ููู"], ["72","ุงูุฌู","28","ููู"], ["73","ุงููุฒูู","20","ููู"], ["74","ุงููุฏุซุฑ","56","ููู"], ["75","ุงูููุงูุฉ","40","ููู"],
    ["76","ุงูุฅูุณุงู","31","ูุฏูู"], ["77","ุงููุฑุณูุงุช","50","ููู"], ["78","ุงููุจุฃ","40","ููู"], ["79","ุงููุงุฒุนุงุช","46","ููู"], ["80","ุนุจุณ","42","ููู"],
    ["81","ุงูุชูููุฑ","29","ููู"], ["82","ุงูุงููุทุงุฑ","19","ููู"], ["83","ุงููุทูููู","36","ููู"], ["84","ุงูุงูุดูุงู","25","ููู"], ["85","ุงูุจุฑูุฌ","22","ููู"],
    ["86","ุงูุทุงุฑู","17","ููู"], ["87","ุงูุฃุนูู","19","ููู"], ["88","ุงูุบุงุดูุฉ","26","ููู"], ["89","ุงููุฌุฑ","30","ููู"], ["90","ุงูุจูุฏ","20","ููู"], ["91","ุงูุดูุณ","15","ููู"], ["92","ุงูููู","21","ููู"], ["93","ุงูุถุญู","11","ููู"],
    ["94","ุงูุดุฑุญ","8","ููู"], ["95","ุงูุชูู","8","ููู"], ["96","ุงูุนูู","19","ููู"], ["97","ุงููุฏุฑ","5","ููู"], ["98","ุงูุจููุฉ","8","ูุฏูู"],
    ["99","ุงูุฒูุฒูุฉ","8","ูุฏูู"], ["100","ุงูุนุงุฏูุงุช","11","ููู"], ["101","ุงููุงุฑุนุฉ","11","ููู"], ["102","ุงูุชูุงุซุฑ","8","ููู"], ["103","ุงูุนุตุฑ","3","ููู"],
    ["104","ุงูููุฒุฉ","9","ููู"], ["105","ุงูููู","5","ููู"], ["106","ูุฑูุด","4","ููู"], ["107","ุงููุงุนูู","7","ููู"], ["108","ุงูููุซุฑ","3","ููู"],
    ["109","ุงููุงูุฑูู","6","ููู"], ["110","ุงููุตุฑ","3","ูุฏูู"], ["111","ุงููุณุฏ","5","ููู"], ["112","ุงูุฅุฎูุงุต","4","ููู"], ["113","ุงูููู","5","ููู"],
    ["114","ุงููุงุณ","6","ููู"]
  ];
  var existingCodes = sheet.getLastRow() > 1 ? sheet.getRange(2,1,sheet.getLastRow()-1,1).getValues().flat() : [];
  var newRows = surahs.filter(s => !existingCodes.includes(s[0]));

  if(newRows.length) sheet.getRange(sheet.getLastRow()+1,1,newRows.length,newRows[0].length).setValues(newRows);
}

// =================== ุฏุงูุฉ ุชุฃุณูุณ ูุงููุฉ ูุงุญุฏุฉ ===================
function initializeAcademySystem() {
  setupFullSystem();
}

// =================== ูุญุต ูุตูุงูุฉ ุงููุธุงู ===================
function fullSystemCheck() {
  var ss = getMasterSS();
  var sheetNames = [
    "ุงูุฅุนุฏุงุฏุงุช","ุงูุจูุฏุงู_ุงูุนุฑุจูุฉ","ูุงุนุฏุฉ_ุงูุณูุฑ","ุงูุฌูุณุงุช","PasswordResetLogs","ุงูุฃูุณุงู","ุงููุณุชุฎุฏููู",
    "ุงูุฃุฏูุงุฑ","ุงููุฑูุน","ุงูุฏูุฑุงุช","ุงููุฌููุนุงุช","ุชุณุฌููุงุช_ุงูุฏูุฑุงุช","ุชูุฏู_ุงูุทุงูุจ","ุชูููุฐ_ุงูููุงู_ูู_ุงูุทูุงุจ",
    "ููุงู_ุงูุทูุงุจ","ูุฏููุนุงุช_ุงูุชุณุฌูู","ุงูุฎุตููุงุช","ุงูุงุฎุชุจุงุฑุงุช","ุจูู_ุงูุฃุณุฆูุฉ","ุงุฎุชุจุงุฑ_ุฃุณุฆูุฉ",
    "ูุชุงุฆุฌ_ุงูุงุฎุชุจุงุฑุงุช","ุงูุดูุงุฏุงุช","ูููุงุช_ุงูุดุงุช","ุฃุนุถุงุก_ุงููููุงุช","ุฑุณุงุฆู_ุงูุดุงุช","ูุฑููุงุช_ุงูุฑุณุงุฆู",
    "ุชุซุจูุช_ุงูุฑุณุงุฆู","ูุญุงุฏุซุงุช_ุงูุจุฑูุฏ","ุฑุณุงุฆู_ุงูุจุฑูุฏ","ูุณุชููู_ุงููุญุงุฏุซุงุช","ุณุฌู_ุงููุดุงุทุงุช","ุณุฌู_ุงูุฃุฎุทุงุก"
  ];

  var fillFuncs = {
    "ุงูุฅุนุฏุงุฏุงุช": fillSettings,
    "ุงูุจูุฏุงู_ุงูุนุฑุจูุฉ": setupArabCountries,
    "ูุงุนุฏุฉ_ุงูุณูุฑ": fillSurahData
  };

  var finalReport = [];
  sheetNames.forEach(function(name) {
    var sheet = ss.getSheetByName(name) || ss.insertSheet(name);
    if(!sheet.getLastRow() || sheet.getLastRow() === 1) {
      if(fillFuncs[name]) fillFuncs[name](sheet);
      finalReport.push("โ " + name + ": ุชู ุชุนุจุฆุชูุง ุชููุงุฆููุง ุฃู ุชู ุฅูุดุงุคูุง");
    } else {
      finalReport.push("โ " + name + ": ููุฌูุฏุฉ ูููููุกุฉ");
    }
  });

  SpreadsheetApp.getUi().alert("๐ ุชูุฑูุฑ ุตูุงูุฉ ุงููุธุงู:\n\n" + finalReport.join("\n"));
}


/**
 * ุชูููุฏ ูุนุฑู ูุฑูุฏ ูุฃู ูุฑูุฉ (ูุณุฎุฉ ูุญุณูุฉ)
 * @param {string} type - ููุน ุงูููุงู (ูุซู: "ุงููุณุชุฎุฏููู", "ุงูุฏูุฑุงุช")
 * @return {string} ูุนุฑู ุฌุฏูุฏ ูุฑูุฏ
 */
function generateUniqueIdSafe(type) {
  const sheetMap = {
    "ุงููุณุชุฎุฏููู":       { sheet: "ุงููุณุชุฎุฏููู",       col: "ูุนุฑู_ุงููุณุชุฎุฏู", prefix: "USR" },
    "ุงูุฏูุฑุงุช":          { sheet: "ุงูุฏูุฑุงุช",          col: "ูุนุฑู_ุงูุฏูุฑุฉ",   prefix: "CRS" },
    "ุงููุฌููุนุงุช":        { sheet: "ุงููุฌููุนุงุช",        col: "ูุนุฑู_ุงููุฌููุนุฉ", prefix: "GRP" },
    "ุงูุฃุฏูุงุฑ":          { sheet: "ุงูุฃุฏูุงุฑ",          col: "ูุนุฑู_ุงูุฏูุฑ",    prefix: "ROL" },
    "ุงููุฑูุน":           { sheet: "ุงููุฑูุน",           col: "ูุนุฑู_ุงููุฑุน",    prefix: "BRN" },
    "ุงูุจูุฏุงู_ุงูุนุฑุจูุฉ":  { sheet: "ุงูุจูุฏุงู_ุงูุนุฑุจูุฉ",  col: "ูุนุฑู_ุงูุจูุฏ",    prefix: "CNT" },
    "ุงูุฃูุณุงู":           { sheet: "ุงูุฃูุณุงู",           col: "ูุนุฑู_ุงููุณู",    prefix: "SEC" },
    "ุชุณุฌููุงุช_ุงูุฏูุฑุงุช":   { sheet: "ุชุณุฌููุงุช_ุงูุฏูุฑุงุช",  col: "ูุนุฑู_ุงูุชุณุฌูู",  prefix: "REG" },
    "ุชูุฏู_ุงูุทุงูุจ":       { sheet: "ุชูุฏู_ุงูุทุงูุจ",       col: "ูุนุฑู_ุงูุชูุฏู",   prefix: "PRG" },
    "ููุงู_ุงูุทูุงุจ":       { sheet: "ููุงู_ุงูุทูุงุจ",       col: "ูุนุฑู_ุงููููุฉ",   prefix: "TAS" },
    "ูุฏููุนุงุช_ุงูุชุณุฌูู":   { sheet: "ูุฏููุนุงุช_ุงูุชุณุฌูู",  col: "ูุนุฑู_ุงูุฏูุน",     prefix: "PAY" },
    "ุงูุฎุตููุงุช":          { sheet: "ุงูุฎุตููุงุช",         col: "ูุนุฑู_ุงูุฎุตู",     prefix: "DSC" },
    "ุงูุงุฎุชุจุงุฑุงุช":        { sheet: "ุงูุงุฎุชุจุงุฑุงุช",       col: "ูุนุฑู_ุงูุงุฎุชุจุงุฑ", prefix: "TST" },
    "ุจูู_ุงูุฃุณุฆูุฉ":       { sheet: "ุจูู_ุงูุฃุณุฆูุฉ",      col: "ูุนุฑู_ุงูุณุคุงู",   prefix: "QST" },
    "ุงุฎุชุจุงุฑ_ุฃุณุฆูุฉ":      { sheet: "ุงุฎุชุจุงุฑ_ุฃุณุฆูุฉ",     col: "ูุนุฑู_ุงูุฑุจุท",    prefix: "LNK" },
    "ูุชุงุฆุฌ_ุงูุงุฎุชุจุงุฑุงุช":  { sheet: "ูุชุงุฆุฌ_ุงูุงุฎุชุจุงุฑุงุช", col: "ูุนุฑู_ุงููุชูุฌุฉ",  prefix: "RSL" },
    "ุงูุดูุงุฏุงุช":          { sheet: "ุงูุดูุงุฏุงุช",         col: "ูุนุฑู_ุงูุดูุงุฏุฉ",  prefix: "CRT" },
    "ูููุงุช_ุงูุดุงุช":       { sheet: "ูููุงุช_ุงูุดุงุช",      col: "ูุนุฑู_ุงูููุงุฉ",   prefix: "CHN" },
    "ุฃุนุถุงุก_ุงููููุงุช":    { sheet: "ุฃุนุถุงุก_ุงููููุงุช",    col: "ูุนุฑู_ุงูุนุถููุฉ",  prefix: "MEM" },
    "ุฑุณุงุฆู_ุงูุดุงุช":       { sheet: "ุฑุณุงุฆู_ุงูุดุงุช",      col: "ูุนุฑู_ุงูุฑุณุงูุฉ",  prefix: "MSG" },
    "ูุฑููุงุช_ุงูุฑุณุงุฆู":    { sheet: "ูุฑููุงุช_ุงูุฑุณุงุฆู",    col: "ูุนุฑู_ุงููุฑูู",   prefix: "ATT" },
    "ุชุซุจูุช_ุงูุฑุณุงุฆู":     { sheet: "ุชุซุจูุช_ุงูุฑุณุงุฆู",     col: "ูุนุฑู_ุงูุชุซุจูุช",  prefix: "PIN" },
    "ูุญุงุฏุซุงุช_ุงูุจุฑูุฏ":     { sheet: "ูุญุงุฏุซุงุช_ุงูุจุฑูุฏ",     col: "ูุนุฑู_ุงููุญุงุฏุซุฉ", prefix: "EMC" },
    "ุฑุณุงุฆู_ุงูุจุฑูุฏ":       { sheet: "ุฑุณุงุฆู_ุงูุจุฑูุฏ",       col: "ูุนุฑู_ุงูุฑุณุงูุฉ",  prefix: "EMG" },
    "ูุณุชููู_ุงููุญุงุฏุซุงุช":  { sheet: "ูุณุชููู_ุงููุญุงุฏุซุงุช",  col: "ูุนุฑู_ุงูุฑุจุท",    prefix: "EML" },
    "ุณุฌู_ุงููุดุงุทุงุช":       { sheet: "ุณุฌู_ุงููุดุงุทุงุช",       col: "ูุนุฑู_ุงูุณุฌู",    prefix: "LOG" },
    "ุงููุญูุธุฉ_ุงููุงููุฉ":       { sheet: "ุงููุญูุธุฉ_ุงููุงููุฉ",       col: "ูุนุฑู_ุงูุณุฌู",    prefix: "FIPO" },
    "ุณุฌู_ุงูุฃุฎุทุงุก":        { sheet: "ุณุฌู_ุงูุฃุฎุทุงุก",        col: "ูุนุฑู_ุงูุฎุทุฃ",    prefix: "ERR" }
  };

  const cfg = sheetMap[type];
  if (!cfg) throw new Error("ููุน ุบูุฑ ูุฏุนูู ูุชูููุฏ ุงููุนุฑู: " + type);

  const sheet = getMasterSS().getSheetByName(cfg.sheet);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const colIndex = headers.indexOf(cfg.col);
  if (colIndex === -1) throw new Error("ุงูุนููุฏ " + cfg.col + " ุบูุฑ ููุฌูุฏ ูู ุงููุฑูุฉ " + cfg.sheet);

  // ุงูุจุญุซ ุนู ุฃูุจุฑ ุฑูู ูุณุชุฎุฏู ุญุงูููุง
  let maxNumber = 0;
  for (let i = 1; i < data.length; i++) {
    const val = data[i][colIndex];
    if (!val) continue;
    const parts = val.split("-");
    const numPart = parseInt(parts[1], 10);
    if (!isNaN(numPart) && numPart > maxNumber) maxNumber = numPart;
  }

  const newIdNumber = (maxNumber + 1).toString().padStart(8, "0");
  return `${cfg.prefix}-${newIdNumber}`;
}

// ูุซุงู ุงุณุชุฎุฏุงู
Logger.log(generateUniqueIdSafe("ุงููุณุชุฎุฏููู")); // USR-000001
Logger.log(generateUniqueIdSafe("ุงูุฏูุฑุงุช"));    // CRS-000001
Logger.log(generateUniqueIdSafe("ุงููุฌููุนุงุช"));  // GRP-000001




/**
 * ุชูููุฏ ูุนุฑู ุฎุงุต (6 ุญุฑูู ูุฑูููู) ููุญุตู ูู ุฌุฏูู ุงููุณุชุฎุฏููู
 */
function generateSpecialCustomId() {
  const ss = getMasterSS();
  const usersSheet = ss.getSheetByName("ุงููุณุชุฎุฏููู");
  const existingIds = usersSheet.getLastRow() > 1 
    ? usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 1).getValues().flat() 
    : [];
  
  let newCode;
  let isUnique = false;
  
  while (!isUnique) {
    let letters = "";
    for (let i = 0; i < 6; i++) {
      letters += String.fromCharCode(65 + Math.floor(Math.random() * 26));
    }
    let numbers = Math.floor(Math.random() * 90 + 10).toString();
    newCode = letters + numbers;
    if (!existingIds.includes(newCode)) isUnique = true;
  }
  return newCode;
}






//=====ุชุณุฌูู ุฏุฎูู ูุณุชุฎุฏู =====
function loginUser(email, password) {
  var sheet = getMasterSS().getSheetByName("ุงููุณุชุฎุฏููู");
  var data = sheet.getDataRange().getValues();
  var headers = data.shift();
  
  // ุชุญุฏูุฏ ููุงูุน ุงูุฃุนูุฏุฉ ุจุฏูุฉ
  const emailIdx = headers.indexOf("ุงูุจุฑูุฏ_ุงูุฅููุชุฑููู");
  const saltIdx = headers.indexOf("salt");
  const hashIdx = headers.indexOf("password_hash");
  const idIdx = headers.indexOf("ูุนุฑู_ุงููุณุชุฎุฏู");
  const nameIdx = headers.indexOf("ุงูุงุณู_ุงููุงูู");
  const roleIdx = headers.indexOf("ุงูุฑุชุจุฉ"); // ุชุฃูุฏ ูู ูุฌูุฏ ูุฐุง ุงูุนููุฏ ูู ุงูุดูุช
  const lastLoginIdx = headers.indexOf("ุขุฎุฑ_ุชุณุฌูู_ุฏุฎูู");

  for (var i = 0; i < data.length; i++) {
    if (data[i][emailIdx] === email) {
      var salt = data[i][saltIdx];
      var hash = data[i][hashIdx];
      
      if(hashPassword(password, salt) === hash){
        // ุณุฌู ููุช ุงูุฏุฎูู
        sheet.getRange(i + 2, lastLoginIdx + 1).setValue(new Date());
        
        // ุฅุฑุฌุงุน ุงูุจูุงูุงุช ูุงููุฉ ูููุชุตูุญ
        return { 
          success: true, 
          userId: data[i][idIdx], 
          userName: data[i][nameIdx],
          userRole: data[i][roleIdx] // ูุฐู ุงููููุฉ ูู ูุญุฑู ููุญุฉ ุงูุชุญูู
        };
      } else {
        return { success: false, message: "ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ" };
      }
    }
  }
  return { success: false, message: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ููุฌูุฏ" };
}


function getCurrentRole(userId) {
  var sheet = getMasterSS().getSheetByName("ุงููุณุชุฎุฏููู");
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  
  var idIdx = headers.indexOf("ูุนุฑู_ุงููุณุชุฎุฏู");
  var roleIdx = headers.indexOf("ูุนุฑู_ุงูุฏูุฑ");

  for (var i = 1; i < data.length; i++) {
    if (data[i][idIdx] === userId) {
      return { success: true, roleId: data[i][roleIdx] };
    }
  }
  return { success: false };
}



// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุฌุฒุฆุฉ ูููุฉ ุงููุฑูุฑ
function hashPassword(password, salt){
  return Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password + salt).map(b => ('00' + (b & 0xFF).toString(16)).slice(-2)).join('');
}






/**
 * ุชูููุฏ ุฑูู ุชุญูู ูุชุณูุณู ููุดูุงุฏุงุช
 * @returns {string} ุฑูู ุชุญูู ุจุตูุบุฉ CA-000000001
 */
function generateCertificateCode() {
  const prefix = "CA-";
  const sheet = getMasterSS().getSheetByName("ุงูุดูุงุฏุงุช");
  const data = sheet.getDataRange().getValues();
  const colIndex = data[0].indexOf("ุฑูู_ุงูุชุญูู");

  let lastNumber = 0;

  for (let i = 1; i < data.length; i++) {
    const code = data[i][colIndex];
    if (!code) continue;
    const parts = code.split("-");
    const numPart = parseInt(parts[1], 10);
    if (!isNaN(numPart) && numPart > lastNumber) lastNumber = numPart;
  }

  const newNumber = (lastNumber + 1).toString().padStart(9, "0");
  return prefix + newNumber;
}

/**
 * ุชุณุฌูู ุณุฌู ุฌุฏูุฏ ูุฃู ุฌุฏูู ูุน ุฏุนู ุงููุนุฑูุงุช ูุงูุฃุนูุฏุฉ ุงููุฑูุฏุฉ
 * @param {string} sheetName - ุงุณู ุงููุฑูุฉ
 * @param {Object} rowData - ุจูุงูุงุช ุงูุณุฌู
 * @param {Array} uniqueColumns - ุฃุณูุงุก ุงูุฃุนูุฏุฉ ุงููุฑูุฏุฉ
 * @param {string} idColumn - ุงุณู ุงูุนููุฏ ูุชูููุฏ ุงููุนุฑู ุงููุฑูุฏ
 * @returns {Object} ูุชูุฌุฉ ุงูุชุณุฌูู
 */
function registerRecord(sheetName, rowData, uniqueColumns = [], idColumn = "") {
  const sheet = getMasterSS().getSheetByName(sheetName);
  if (!sheet) return { success: false, message: "ุงููุฑูุฉ " + sheetName + " ุบูุฑ ููุฌูุฏุฉ" };

  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  // 1. ุงูุชุญูู ูู ุงูููู ุงููุฑูุฏุฉ
  for (let colName of uniqueColumns) {
    const colIndex = headers.indexOf(colName);
    if (colIndex !== -1) {
      const exists = data.some((row,i) => i > 0 && row[colIndex] === rowData[colName]);
      if (exists) return { success: false, message: `ุงููููุฉ ูู ุนููุฏ [${colName}] ููุฌูุฏุฉ ูุณุจูุงู` };
    }
  }

// 2. ุชูููุฏ ุงููุนุฑู ุงููุฑูุฏ ุฅุฐุง ูุฒู ุงูุฃูุฑ
if (idColumn && !rowData[idColumn]) {
  rowData[idColumn] = generateUniqueIdSafe(sheetName); // ุงุณุชุฎุฏู ุงููุณุฎุฉ ุงูุขููุฉ ุงูุขู
}

  // 3. ุชูููุฏ ุฑูู ุชุญูู ูุชุณูุณู ุฅุฐุง ูุงูุช ุงูุดูุงุฏุฉ
  if(sheetName === "ุงูุดูุงุฏุงุช" && !rowData["ุฑูู_ุงูุชุญูู"]) {
    rowData["ุฑูู_ุงูุชุญูู"] = generateCertificateCode();
  }

  // 4. ุจูุงุก ุงูุตู ุงูุฌุฏูุฏ ุจูุงุกู ุนูู ุงูุฃุนูุฏุฉ ุงูููุฌูุฏุฉ
  const newRow = headers.map(col => {
    if (rowData[col] !== undefined) return rowData[col];

    // ููู ุงูุชุฑุงุถูุฉ
    switch(col) {
      case "ุชุงุฑูุฎ_ุงูุฅูุดุงุก":
      case "ุขุฎุฑ_ุชุญุฏูุซ": return new Date();
      case "ุงูุญุงูุฉ": return "ูุดุท";
      default: return "";
    }
  });

  // 5. ุฅุถุงูุฉ ุงูุตู ูููุฑูุฉ
  sheet.appendRow(newRow);

  return { success: true, id: rowData[idColumn] || null, code: rowData["ุฑูู_ุงูุชุญูู"] || null, message: "ุชู ุงูุชุณุฌูู ุจูุฌุงุญ" };
}


/**
 * ุฏุงูุฉ ูุฑูุฒูุฉ ูุฌูุจ ุงูุจูุงูุงุช ูู ุฃู ูุฑูุฉ
 * @param {string} sheetName - ุงุณู ุงููุฑูุฉ
 * @param {Object} conditions - ูุงุฆู ุงูุดุฑูุท { "ุงุณู_ุงูุนููุฏ": { value: "ุงููููุฉ", partial: true/false, caseSensitive: true/false } }
 *                              ุฅุฐุง conditions = { "ุงูุงุณู": { value: "ุนูู", partial: true, caseSensitive: false } }
 *                              ุณุชุจุญุซ ุนู ุฃู ุงุณู ูุญุชูู "ุนูู" ุจุบุถ ุงููุธุฑ ุนู ุญุงูุฉ ุงูุฃุญุฑู
 * @param {Array} columns - ูุตูููุฉ ุงูุฃุนูุฏุฉ ุงููุทููุจ ุฌูุจูุง (ุงุฎุชูุงุฑูุ ูุฌูุจ ูู ุงูุฃุนูุฏุฉ ุชุฑููุง ูุงุฑุบุฉ)
 * @returns {Array} ูุตูููุฉ ุณุฌูุงุช ูุทุงุจูุฉ ููุดุฑูุท
 */
function fetchRecords(sheetName, conditions = {}, columns = []) {
  const sheet = getMasterSS().getSheetByName(sheetName);
  if (!sheet) return [];

  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  // ููุชุฑุฉ ุงูุตููู ุญุณุจ ุงูุดุฑูุท
  const filtered = data.slice(1).filter(row => {
    for (let key in conditions) {
      const cond = typeof conditions[key] === 'object'
        ? conditions[key]
        : { value: conditions[key], partial: false, caseSensitive: true };

      const colIndex = headers.indexOf(key);
      if (colIndex === -1) return false; // ุงูุนููุฏ ุบูุฑ ููุฌูุฏ

      let cellValue = row[colIndex] != null ? row[colIndex].toString() : "";

      if (!cond.caseSensitive) {
        cellValue = cellValue.toLowerCase();
        cond.value = cond.value.toLowerCase();
      }

      if (cond.partial) {
        if (!cellValue.includes(cond.value)) return false;
      } else {
        if (cellValue !== cond.value) return false;
      }
    }
    return true;
  });

  // ุงุฎุชูุงุฑ ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ
  if (columns.length === 0) return filtered.map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });

  return filtered.map(row => {
    const obj = {};
    for (let col of columns) {
      const idx = headers.indexOf(col);
      obj[col] = idx !== -1 ? row[idx] : null;
    }
    return obj;
  });
}



/**
 * ุชุญุฏูุซ ุณุฌู ููุฌูุฏ ุจูุงุกู ุนูู ูุนุฑูู ุงููุฑูุฏ
 * @param {string} sheetName - ุงุณู ุงููุฑูุฉ
 * @param {string} idValue - ูููุฉ ุงููุนุฑู (ูุซูุงู: USR-00000001)
 * @param {Object} updateData - ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ุงููุฑุงุฏ ุชุญุฏูุซูุง
 * @param {string} idColumnName - ุงุณู ุนููุฏ ุงููุนุฑู ูู ุชูู ุงููุฑูุฉ
 */
function updateRecord(sheetName, idValue, updateData, idColumnName) {
  const sheet = getMasterSS().getSheetByName(sheetName);
  if (!sheet) return { success: false, message: "ุงููุฑูุฉ ุบูุฑ ููุฌูุฏุฉ" };

  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const idColIndex = headers.indexOf(idColumnName);
  
  if (idColIndex === -1) return { success: false, message: "ุนููุฏ ุงููุนุฑู ุบูุฑ ููุฌูุฏ" };

  // ุงูุจุญุซ ุนู ุฑูู ุงูุตู
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][idColIndex] === idValue) {
      rowIndex = i + 1; // +1 ูุฃู ุงููุตูููุฉ ุชุจุฏุฃ ูู 0 ูุงูุดูุช ูู 1ุ ู +1 ูุชุฎุทู ุงูููุฏุฑ
      break;
    }
  }

  if (rowIndex === -1) return { success: false, message: "ุงูุณุฌู ุบูุฑ ููุฌูุฏ" };

  // ุชุญุฏูุซ ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ ููุท
  for (let key in updateData) {
    const colIdx = headers.indexOf(key);
    if (colIdx !== -1 && key !== idColumnName) { // ูุง ุชุณูุญ ุจุชุนุฏูู ุงููุนุฑู ููุณู
      sheet.getRange(rowIndex, colIdx + 1).setValue(updateData[key]);
    }
  }
  
  // ุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ุชุนุฏูู ุชููุงุฆูุงู ุฅุฐุง ูุฌุฏ ุงูุนููุฏ
  const updateColIdx = headers.indexOf("ุขุฎุฑ_ุชุญุฏูุซ");
  if (updateColIdx !== -1) {
    sheet.getRange(rowIndex, updateColIdx + 1).setValue(new Date());
  }

  return { success: true, message: "ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ" };
}


/**
 * ุงูุฏุงูุฉ ุงููุฑูุฒูุฉ ููุนุงูุฌุฉ ุงูุทูุจุงุช ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
 * @param {string} action - ููุน ุงูุนูููุฉ (register, login, update, fetch)
 * @param {Object} payload - ุงูุจูุงูุงุช ุงููุฑุณูุฉ
 */
function handleClientRequest(action, payload) {
  try {
    switch (action) {
      case "login":
        return loginUser(payload.email, payload.password);
      
    case "registerUser":
  const salt = Utilities.getUuid();
  const hashed = hashPassword(payload.data.password, salt);
  
  // ุชุญุฏูุฏ ุงูููุฏูุจ: ุฅุฐุง ูู ูุฃุชู ูุนุฑู ููุฏูุจุ ูุถุนู ูุงุฑุบุงู ุฃู DIRECT
  const referrerId = payload.data.referrer || "";

  return registerRecord("ุงููุณุชุฎุฏููู", {
    "ุงูุงุณู_ุงููุงูู": payload.data.name,
    "ุงูุจุฑูุฏ_ุงูุฅููุชุฑููู": payload.data.email,
    "password_hash": hashed,
    "salt": salt,
    "ูุนุฑู_ุงูุฏูุฑ": "ROL-00000004", // ุฏูุฑ ุทุงูุจ ุงูุชุฑุงุถู
    "ูุนุฑู_ุงููุฑุน": payload.data.country, 
    "ุฑูู_ุงููุงุชู": payload.data.phone,
    "ุงููุฏููุฉ": payload.data.city || "ุบูุฑ ูุญุฏุฏ",
    "ุงูุจูุฏ": payload.data.country,
    "ุงูุฌูุณ": payload.data.gender,
    "ุงูุญุงูุฉ": "ูุดุท",
    "ูุนุฑู_ุงูููุฏูุจ_ุงูููุญูู": referrerId, // ุงูุฑุจุท ูุน ุงูููุฏูุจ ููุง โ
    "ุฃูุดุฆ_ุจูุงุณุทุฉ": "SELF"
  }, ["ุงูุจุฑูุฏ_ุงูุฅููุชุฑููู"], "ูุนุฑู_ุงููุณุชุฎุฏู");

      
      
            case "getDelegateStats":
        // ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุงูุชู ุดุฑุญูุงูุง ุณุงุจูุงู
        return getDelegatePerformance(payload.delegateId);

// ุฃุถู ูุฐุง ุงูุณุทุฑ ุฏุงุฎู switch (action)
case "promoteUser":
  return promoteUserAction(payload.userId, payload.targetRole);

      case "getTeacherStats":
        return getTeacherPerformance(payload.teacherId);
        //ุงูุญุถูุฑ ูุงูุงูุตุฑุงู 
      case "submitAttendance":
        return submitAttendance(payload.groupId, payload.attendanceList);
        //ุฌูุจ ุงูููุงุฆู ุงูููุณุฏูุฉ 
case "getDropdownList":
    return getDropdownData(payload.type); // ูุฐู ุงูุฏุงูุฉ ุงูุขู ูู ุงูุฌููุฑ ููุจูุฏุงู ูุบูุฑูุง

      
      case "fetchCourses":
        return fetchRecords("ุงูุฏูุฑุงุช", payload.conditions || {}, payload.columns || []);
      
      case "updateProfile":
        return updateRecord("ุงููุณุชุฎุฏููู", payload.userId, payload.updateData, "ูุนุฑู_ุงููุณุชุฎุฏู");
      
      default:
        throw new Error("Action not recognized");
    }
  } catch (e) {
    // ุชุณุฌูู ุงูุฎุทุฃ ูู ุฌุฏูู ุณุฌู_ุงูุฃุฎุทุงุก ุงูุฐู ุฃูุดุฃุชู ุณุงุจูุงู
    registerRecord("ุณุฌู_ุงูุฃุฎุทุงุก", {
      "ุงููุตุฏุฑ": "handleClientRequest",
      "ุงูุฑุณุงูุฉ": e.message,
      "ุงูุจูุงูุงุช": JSON.stringify(payload)
    });
    return { success: false, message: e.toString() };
  }
}



function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const result = handleClientRequest(data.action, data.payload);

  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}



//======ุฏุงูุฉ ุฌูุจ ุงูุนูููุงุช ููููุฏูุจูู =====

/**
 * ุฏุงูุฉ ุชุญููู ุฃุฏุงุก ุงูููุฏูุจ ูุงุณุชุฎุฑุงุฌ ุงูุฃุฑูุงู ุงููุงููุฉ
 * @param {string} delegateId - ูุนุฑู ุงูููุฏูุจ ุงููุฑุงุฏ ูุญุตู
 */
function getDelegatePerformance(delegateId) {
  try {
    const ss = getMasterSS();
    
    // 1. ุฌูุจ ุฅุนุฏุงุฏุงุช ุงูุนูููุฉ ูู ุฌุฏูู ุงูุฅุนุฏุงุฏุงุช
    const settings = fetchRecords("ุงูุฅุนุฏุงุฏุงุช", {"ุงูุนููุงู": "DELEGATE_COMMISSION_PERCENT"});
    // ุฅุฐุง ูู ุชูุฌุฏ ุฅุนุฏุงุฏุงุชุ ูุณุชุฎุฏู 10% ูุงูุชุฑุงุถู
    const commissionRate = settings.length > 0 ? parseFloat(settings[0].ุงููููุฉ) / 100 : 0.10;

    // 2. ุฌูุจ ูุงุฆูุฉ ุงูุทูุงุจ ุงูุฐูู ุณุฌููุง ุนู ุทุฑูู ูุฐุง ุงูููุฏูุจ
    // ูุจุญุซ ูู ุฌุฏูู ุงููุณุชุฎุฏููู ุนู ูู ูู ูุฏูู "ูุนุฑู_ุงูููุฏูุจ_ุงูููุญูู" ูุณุงูู ุงูู ID ุงูููุฑุฑ
    const myStudents = fetchRecords("ุงููุณุชุฎุฏููู", {"ูุนุฑู_ุงูููุฏูุจ_ุงูููุญูู": delegateId}, ["ูุนุฑู_ุงููุณุชุฎุฏู", "ุงูุงุณู_ุงููุงูู", "ุชุงุฑูุฎ_ุงูุฅูุดุงุก"]);
    
    // ุงุณุชุฎุฑุงุฌ ูุตูููุฉ ุจูุนุฑูุงุช ุงูุทูุงุจ ููุท ููุจุญุซ ุนู ูุฏููุนุงุชูู
    const studentIds = myStudents.map(s => s.ูุนุฑู_ุงููุณุชุฎุฏู);
    
    let totalSales = 0;
    let confirmedStudentsCount = 0;

    // 3. ุญุณุงุจ ุงููุจูุนุงุช ุงููุนููุฉ ูู ุฌุฏูู ุงููุฏููุนุงุช
    if (studentIds.length > 0) {
      const paymentSheet = ss.getSheetByName("ูุฏููุนุงุช_ุงูุชุณุฌูู");
      const paymentData = paymentSheet.getDataRange().getValues();
      const pHeaders = paymentData.shift();
      
      const userCol = pHeaders.indexOf("ูุนุฑู_ุงููุณุชุฎุฏู");
      const amountCol = pHeaders.indexOf("ุงููุจูุบ_ุงููุฏููุน");
      const statusCol = pHeaders.indexOf("ุญุงูุฉ_ุงูุฏูุน");

      paymentData.forEach(row => {
        // ุฅุฐุง ูุงู ุงูุทุงูุจ ูุฎุต ุงูููุฏูุจ ูุงูุฏูุนุฉ "ููุจููุฉ"
        if (studentIds.includes(row[userCol]) && row[statusCol] === "ููุจูู") {
          totalSales += parseFloat(row[amountCol] || 0);
          confirmedStudentsCount++;
        }
      });
    }

    // 4. ุฌูุจ ุงูุฑุตูุฏ ุงูุญุงูู ูู ุฌุฏูู ุงููุญูุธุฉ
    const walletData = fetchRecords("ุงููุญูุธุฉ_ุงููุงููุฉ", {"ูุนุฑู_ุงููุณุชุฎุฏู": delegateId});
    const wallet = walletData.length > 0 ? walletData[0] : { ุงูุฑุตูุฏ_ุงูุญุงูู: 0, ุฅุฌูุงูู_ุงููุณุญูุจุงุช: 0 };

    // 5. ุชุฌููุน ุงูุชูุฑูุฑ ุงูููุงุฆู
    return {
      success: true,
      data: {
        summary: {
          totalReferrals: myStudents.length,          // ุฅุฌูุงูู ูู ุณุฌููุง (ุฏูุนูุง ุฃู ูู ูุฏูุนูุง)
          activeStudents: confirmedStudentsCount,    // ุงูุทูุงุจ ุงูุฐูู ุฏูุนูุง ูุนููุงู
          totalSales: totalSales,                    // ุฅุฌูุงูู ุงููุจุงูุบ ุงูุชู ุฏุฎูุช ุงูุฃูุงุฏูููุฉ ุจุณุจุจู
          totalCommission: totalSales * commissionRate, // ุฅุฌูุงูู ุนูููุชู ุงููุณุชุญูุฉ ุชุงุฑูุฎูุงู
          currentBalance: wallet.ุงูุฑุตูุฏ_ุงูุญุงูู,      // ุงูุฑุตูุฏ ุงููุชููุฑ ูู ูุญูุธุชู ุงูุขู
          withdrawn: wallet.ุฅุฌูุงูู_ุงููุณุญูุจุงุช         // ูุง ูุงู ุจุณุญุจู ุณุงุจูุงู
        },
        studentsList: myStudents // ูุงุฆูุฉ ุจุงูุฃุณูุงุก ูุนุฑุถูุง ูู ููุญุฉ ุชุญููู
      }
    };

  } catch (e) {
    return { success: false, message: "ุฎุทุฃ ูู ุญุณุงุจ ุงูุฃุฏุงุก: " + e.toString() };
  }
}



/**
 * ุฏุงูุฉ ุฌูุจ ุชูุฑูุฑ ุฃุฏุงุก ุงููุนูู ูุงููุฌููุนุงุช ุงููุณุคููุฉ
 * @param {string} teacherId - ูุนุฑู ุงููุณุชุฎุฏู ุงูุฎุงุต ุจุงููุนูู
 */
function getTeacherPerformance(teacherId) {
  try {
    const ss = getMasterSS();
    
    // 1. ุฌูุจ ุงููุฌููุนุงุช ุงูุชู ูุฏุฑุณูุง ูุฐุง ุงููุนูู
    const myGroups = fetchRecords("ุงููุฌููุนุงุช", {"ูุนุฑู_ุงููุนูู": teacherId});
    const groupIds = myGroups.map(g => g.ูุนุฑู_ุงููุฌููุนุฉ);

    if (groupIds.length === 0) {
      return { success: true, data: { summary: "ูุง ุชูุฌุฏ ูุฌููุนุงุช ูุณูุฏุฉ ุญุงููุงู", groups: [] } };
    }

    // 2. ุญุณุงุจ ุฅุฌูุงูู ุงูุทูุงุจ ูู ุฌููุน ูุฌููุนุงุชู ูู ุฌุฏูู "ูุงุนุฏุฉ_ุงูุจูุงูุงุช_ุงูุทูุงุจ"
    const allStudents = fetchRecords("ูุงุนุฏุฉ_ุงูุจูุงูุงุช_ุงูุทูุงุจ", {"ูุนุฑู_ุงููุนูู": teacherId}, ["ูุนุฑู_ุงููุณุชุฎุฏู", "ูุนุฑู_ุงููุฌููุนุฉ", "ุญุงูุฉ_ุงูุชุณุฌูู"]);
    const activeStudents = allStudents.filter(s => s.ุญุงูุฉ_ุงูุชุณุฌูู === "ูุดุท").length;

    // 3. ุชุญููู ุงูุญุถูุฑ ูุงูุบูุงุจ ูู "ุณุฌู_ุงูุญุถูุฑ_ุงูุชูุตููู"
    const attendanceSheet = ss.getSheetByName("ุณุฌู_ุงูุญุถูุฑ_ุงูุชูุตููู");
    const attData = attendanceSheet.getDataRange().getValues();
    const attHeaders = attData.shift();
    
    const groupCol = attHeaders.indexOf("ูุนุฑู_ุงููุฌููุนุฉ");
    const statusCol = attHeaders.indexOf("ุงูุญุงูุฉ");

    let totalSessions = 0;
    let totalAbsences = 0;

    attData.forEach(row => {
      if (groupIds.includes(row[groupCol])) {
        totalSessions++;
        if (row[statusCol] === "ุบุงุฆุจ") totalAbsences++;
      }
    });

    // 4. ุจูุงุก ุงูุชูุฑูุฑ ุงูููุงุฆู ูููุนูู
    return {
      success: true,
      data: {
        summary: {
          groupsCount: myGroups.length,        // ุนุฏุฏ ุงููุฌููุนุงุช
          totalStudents: allStudents.length,  // ุฅุฌูุงูู ุงูุทูุงุจ
          activeStudents: activeStudents,     // ุงูุทูุงุจ ุงููุดุทูู
          totalAttendanceRecords: totalSessions, // ุฅุฌูุงูู ุณุฌูุงุช ุงูุญุถูุฑ ุงููุฃุฎูุฐุฉ
          absenceRate: totalSessions > 0 ? ((totalAbsences / totalSessions) * 100).toFixed(2) + "%" : "0%"
        },
        groupsDetails: myGroups // ูุงุฆูุฉ ุงููุฌููุนุงุช ุจููุงุนูุฏูุง
      }
    };

  } catch (e) {
    return { success: false, message: "ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงููุนูู: " + e.toString() };
  }
}
/**
 * ุฏุงูุฉ ุชุณุฌูู ุงูุญุถูุฑ ูุงูุบูุงุจ ููุฌููุนุฉ ูุนููุฉ
 * @param {string} groupId - ูุนุฑู ุงููุฌููุนุฉ
 * @param {Array} attendanceList - ูุตูููุฉ ุงููุงุฆูุงุช [{userId: "...", status: "ุญุงุถุฑ", note: "..."}]
 */
function submitAttendance(groupId, attendanceList) {
  try {
    const ss = getMasterSS();
    const sheet = ss.getSheetByName("ุณุฌู_ุงูุญุถูุฑ_ุงูุชูุตููู");
    const today = new Date();
    
    // ุชุณุฌูู ูู ุทุงูุจ ูู ุณุทุฑ ุฌุฏูุฏ
    attendanceList.forEach(record => {
      const rowData = {
        "ูุนุฑู_ุงูุญุถูุฑ": generateUniqueIdSafe("ุณุฌู_ุงูุญุถูุฑ_ุงูุชูุตููู"),
        "ูุนุฑู_ุงููุฌููุนุฉ": groupId,
        "ูุนุฑู_ุงููุณุชุฎุฏู": record.userId,
        "ุงูุชุงุฑูุฎ": today,
        "ุงูุญุงูุฉ": record.status, // ุญุงุถุฑุฉุ ุบุงุฆุจุ ูุชุฃุฎุฑ
        "ููุงุญุธุงุช_ุงููุนูู": record.note || ""
      };
      
      // ุงุณุชุฎุฏุงู ุฏุงูุฉ registerRecord ูุถูุงู ุงูุงุชุณุงู
      registerRecord("ุณุฌู_ุงูุญุถูุฑ_ุงูุชูุตููู", rowData);
    });

    // ุชุญุฏูุซ ุชุงุฑูุฎ "ุขุฎุฑ ุญุถูุฑ" ูู ุฌุฏูู ุชูุฏู ุงูุทุงูุจ ุฃูุถุงู
    updateStudentProgress(groupId, attendanceList);

    return { success: true, message: "ุชู ุชุณุฌูู ุงูุญุถูุฑ ุจูุฌุงุญ ูู " + attendanceList.length + " ุทุงูุจ" };
  } catch (e) {
    return { success: false, message: "ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุญุถูุฑ: " + e.toString() };
  }
}

/**
 * ุฏุงูุฉ ูุฑุนูุฉ ูุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ุญุถูุฑ ูู ุฌุฏุงูู ุงูุทูุงุจ
 */
function updateStudentProgress(groupId, attendanceList) {
  const progressSheet = getMasterSS().getSheetByName("ุชูุฏู_ุงูุทุงูุจ");
  // ููุทู ุงูุชุญุฏูุซ ููุง (ุงุฎุชูุงุฑู ุญุณุจ ุญุงุฌุชู)
}





/**
/**
 * ุงูุฏุงูุฉ ุงููุฑูุฒูุฉ ูุชุฑููุฉ ุงููุณุชุฎุฏู ูุชูุฒูุนู ุนูู ุงูุฌุฏุงูู ุงูุชุฎุตุตูุฉ ูุน ูุญุต ูุฒุฏูุฌ
 */
function promoteUserAction(oldUserId, targetRole) {
  try {
    // 1. ุชูููุฏ ุงููุนุฑู ุงูุฌุฏูุฏ TTTTTT11 (ููุญุต ุชููุงุฆูุงู ูู ุฌุฏูู ุงููุณุชุฎุฏููู)
    const specialId = generateSpecialCustomId(); 

    const ss = getMasterSS();
    const userSheet = ss.getSheetByName("ุงููุณุชุฎุฏููู");
    const userData = fetchRecords("ุงููุณุชุฎุฏููู", {"ูุนุฑู_ุงููุณุชุฎุฏู": oldUserId});

    if (userData.length === 0) return { success: false, message: "ุนุฐุฑุงูุ ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ" };
    const user = userData[0];

    // 2. ุชุญุฏูุฏ ุงูุฌุฏูู ุงููุณุชูุฏู ุจูุงุกู ุนูู ุงูุฏูุฑ
    let targetSheetName = "";
    let additionalData = { "ูุนุฑู_ุงููุณุชุฎุฏู": specialId };

    if (targetRole === "ROL-00000003") { // ุฑุชุจุฉ ููุฏูุจ
      targetSheetName = "ุจูุงูุงุช_ุงููุณูููู";
      additionalData["ุงููุงุชู"] = user.ุฑูู_ุงููุงุชู;
      additionalData["ุชุงุฑูุฎ_ุงูุงูุถูุงู"] = new Date();
    } 
    else if (targetRole === "ROL-00000002") { // ุฑุชุจุฉ ูุนูู ุฃู ููุธู
      targetSheetName = "ุฅุฏุงุฑุฉ_ุงููุนูููู_ูุงูููุธููู";
      additionalData["ุฑูู_ุงููุงุชู"] = user.ุฑูู_ุงููุงุชู;
      additionalData["ุชุงุฑูุฎ_ุงูุชุนููู"] = new Date();
      additionalData["ุงูุญุงูุฉ_ุงููุธูููุฉ"] = "ูุดุท";
    }

    if (!targetSheetName) return { success: false, message: "ุงูุฏูุฑ ุงููุฎุชุงุฑ ุบูุฑ ูุฏุนูู ููุชุฑููุฉ ุญุงููุงู" };

    // =================== ุงูุฌุฒุก ุงูุฌุฏูุฏ ุงููุถุงู ููุง ===================
    // ุงูุชุฃูุฏ ูู ุฃู ุงููุนุฑู ุงูุฌุฏูุฏ ูุง ููุฌุฏ ูู ุณุฌู ุณุงุจู ูู ุงูุฌุฏูู ุงูุชุฎุตุตู
    const checkInSubSheet = fetchRecords(targetSheetName, {"ูุนุฑู_ุงููุณุชุฎุฏู": specialId});
    if (checkInSubSheet.length > 0) {
        // ุฅุฐุง ูุฌุฏ (ููุฐุง ูุงุฏุฑ ุฌุฏุงู ุจูุถู ุงููุญุต ุงูุฃูู)ุ ูููู ุจุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุชูููุฏ ID ูุฎุชูู
        return promoteUserAction(oldUserId, targetRole); 
    }
    // ==========================================================

    // 3. ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุฌุฏูู ุงููุณุชุฎุฏููู ุงูุฃุณุงุณู (ุชุบููุฑ ุงูู ID ูุงูู Role)
    const headers = userSheet.getDataRange().getValues()[0];
    const idIdx = headers.indexOf("ูุนุฑู_ุงููุณุชุฎุฏู") + 1;
    const roleIdx = headers.indexOf("ูุนุฑู_ุงูุฏูุฑ") + 1;
    
    const allIds = userSheet.getRange(1, idIdx, userSheet.getLastRow()).getValues();
    let rowIndex = -1;
    for(let i=0; i<allIds.length; i++) {
      if(allIds[i][0] === oldUserId) { rowIndex = i + 1; break; }
    }

    if (rowIndex !== -1) {
      userSheet.getRange(rowIndex, idIdx).setValue(specialId);
      userSheet.getRange(rowIndex, roleIdx).setValue(targetRole);
    }

    // 4. ุฅุฏุฑุงุฌ ุงูุณุฌู ูู ุงูุฌุฏูู ุงูุชุฎุตุตู
    const registration = registerRecord(targetSheetName, additionalData);


// ูุตูููุฉ ุจุงูุฌุฏุงูู ุงูุชู ุชุญุชูู ุนูู ุชุงุฑูุฎ ุงููุณุชุฎุฏู ุงููุฏูู
// ูุตูููุฉ ุดุงููุฉ ูุถูุงู ุนุฏู ุถูุงุน ุฃู ุจูุงู
const tablesToUpdate = [
  "ูุงุนุฏุฉ_ุงูุจูุงูุงุช_ุงูุทูุงุจ", 
  "ูุฏููุนุงุช_ุงูุชุณุฌูู", 
  "ุชุณุฌููุงุช_ุงูุฏูุฑุงุช", 
  "ุณุฌู_ุงููุดุงุทุงุช", 
  "ุณุฌู_ุงูุญุถูุฑ_ุงูุชูุตููู",
  "ุงููุญูุธุฉ_ุงููุงููุฉ",
  "ุณุฌู_ุงูุนูููุงุช_ุงููุงููุฉ",
  "ุชูุฏู_ุงูุทุงูุจ",
  "ูุชุงุฆุฌ_ุงูุงุฎุชุจุงุฑุงุช"
];


tablesToUpdate.forEach(tableName => {
  const sheet = ss.getSheetByName(tableName);
  if (sheet) {
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const userColIdx = headers.indexOf("ูุนุฑู_ุงููุณุชุฎุฏู") + 1;

    if (userColIdx > 0) {
      // ุงูุจุญุซ ุนู ูู ุงูุตููู ุงูุชู ุชุญูู ุงููุนุฑู ุงููุฏูู ูุชุญุฏูุซูุง
      for (let i = 1; i < data.length; i++) {
        if (data[i][userColIdx - 1] === oldUserId) {
          sheet.getRange(i + 1, userColIdx).setValue(specialId);
        }
      }
    }
  }
});



    return { 
      success: true, 
      message: `ุชูุช ุงูุชุฑููุฉ ุฅูู ุฌุฏูู ${targetSheetName} ุจูุฌุงุญ`, 
      newId: specialId 
    };

  } catch (e) {
    return { success: false, message: "ุฎุทุฃ ูู ุงูุชุฑููุฉ: " + e.toString() };
  }
}




/**
 * ุงูุฏุงูุฉ ุงูููุงุฆูุฉ ูุงููุญูุฏุฉ ูุฌูุจ ุงูููุงุฆู ุงูููุณุฏูุฉ
 */
function getDropdownData(type) {
  try {
    let config = {
      "countries": { sheet: "ุงูุจูุฏุงู_ุงูุนุฑุจูุฉ", id: "ูุนุฑู_ุงูุจูุฏ", name: "ุงุณู_ุงูุจูุฏ" }, // ุฃุถููุง ูุฐุง ุงูุณุทุฑ
      "branches":  { sheet: "ุงููุฑูุน", id: "ูุนุฑู_ุงููุฑุน", name: "ุงุณู_ุงููุฑุน" },
      "employees": { sheet: "ุฅุฏุงุฑุฉ_ุงููุนูููู_ูุงูููุธููู", id: "ูุนุฑู_ุงููุณุชุฎุฏู", name: "ุงููุณูู_ุงููุธููู" },
      "users":     { sheet: "ุงููุณุชุฎุฏููู", id: "ูุนุฑู_ุงููุณุชุฎุฏู", name: "ุงูุงุณู_ุงููุงูู" },
      "roles":     { sheet: "ุงูุฃุฏูุงุฑ", id: "ูุนุฑู_ุงูุฏูุฑ", name: "ุงุณู_ุงูุฏูุฑ" }
    };

    let cfg = config[type];
    if (!cfg) return { success: false, message: "ุงูููุน ุบูุฑ ูุฏุนูู" };

    let records = fetchRecords(cfg.sheet, {}, [cfg.id, cfg.name]);
    
    let formattedData = records.map(r => ({
      id: r[cfg.id],
      name: r[cfg.name]
    }));

    return { success: true, data: formattedData };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

//ุฌูุจ ุงููุณุชุฎุฏููู 
function getAllUsers() {
  var sheet = getMasterSS().getSheetByName("ุงููุณุชุฎุฏููู");
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  
  // ุชุญููู ุงูุตููู ุฅูู ูุงุฆูุงุช (Objects) ูุณูููุฉ ุงูุชุนุงูู ูุนูุง ูู ุงูู JavaScript
  var users = [];
  for (var i = 1; i < data.length; i++) {
    var user = {};
    headers.forEach((header, index) => {
      user[header] = data[i][index];
    });
    users.push(user);
  }
  return { success: true, users: users };
}

