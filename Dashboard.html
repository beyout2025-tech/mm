<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - أكاديمية كن أنت</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1e3c72; --secondary: #2a5298; --bg: #f8f9fa; --sidebar-width: 260px; --text: #333; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); display: flex; height: 100vh; color: var(--text); overflow: hidden; }
        
        /* Sidebar & Layout */
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; display: flex; flex-direction: column; transition: 0.3s; position: fixed; top: 0; bottom: 0; right: 0; z-index: 1000; }
        .main-content { flex: 1; margin-right: var(--sidebar-width); display: flex; flex-direction: column; transition: 0.3s; overflow-y: auto; height: 100vh; }
        @media (max-width: 768px) { .sidebar { right: calc(-1 * var(--sidebar-width)); } .sidebar.active { right: 0; } .main-content { margin-right: 0; } .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; } .overlay.active { display: block; } }

        /* Menu */
        .menu-item { padding: 15px 25px; color: #fff; text-decoration: none; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--secondary); border-right: 4px solid #fff; }
        .menu-item i { margin-left: 15px; width: 20px; }

        /* Header & Cards */
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 99; }
        .card { background: white; margin: 20px; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        
        /* Table Styles */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f4f7f9; color: var(--primary); font-weight: 600; }
        tr:hover { background: #fafafa; }
        
        /* Badges & Buttons */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-admin { background: #ffeaa7; color: #d35400; }
        .badge-student { background: #dff9fb; color: #0984e3; }
        .btn-refresh { background: var(--secondary); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .btn-promote { background: #0984e3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save { flex: 1; background: #2ecc71; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-cancel { flex: 1; background: #e74c3c; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; }
        select.modal-input { width: 100%; padding: 12px; margin-top: 15px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; }
        
        .loading-spinner { text-align: center; padding: 30px; color: var(--secondary); }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div style="padding: 25px; text-align: center; background: rgba(0,0,0,0.1);">
            <h3 style="margin:0;">أكاديمية كن أنت</h3>
            <small id="roleText">جاري التحقق...</small>
        </div>
        <div class="sidebar-menu">
            <a class="menu-item active" onclick="showSection('homeSection', this)"><i class="fas fa-th-large"></i> الرئيسة</a>
            
            <div id="studentMenu" class="hidden">
                <a class="menu-item" onclick="showSection('coursesSection', this)"><i class="fas fa-graduation-cap"></i> دوراتي</a>
            </div>
            
            <div id="affiliateMenu" class="hidden">
                <a class="menu-item" onclick="showSection('marketingSection', this)"><i class="fas fa-share-alt"></i> التسويق</a>
            </div>
            
            <div id="adminMenu" class="hidden">
                <a class="menu-item" onclick="showSection('adminSection', this); loadUsers();"><i class="fas fa-user-shield"></i> إدارة المستخدمين</a>
            </div>

            <a class="menu-item" onclick="logout()" style="color: #ff7675; margin-top: auto;"><i class="fas fa-power-off"></i> خروج</a>
        </div>
    </div>

    <div class="main-content">
        <header>
            <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            <div id="welcomeTitle">لوحة التحكم</div>
            <div class="user-box"><i class="fas fa-user-circle"></i> <span id="userName">...</span></div>
        </header>

        <div id="homeSection" class="content-section">
            <div class="card">
                <h3>أهلاً بك في مساحتك الخاصة</h3>
                <p id="debugInfo" style="color: #999; font-size: 12px;"></p>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <p>استخدم القائمة الجانبية للوصول إلى كافة الأقسام المتاحة لك بناءً على رتبتك الحالية.</p>
            </div>
        </div>

        <div id="adminSection" class="content-section hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h3><i class="fas fa-users"></i> إدارة المستخدمين</h3>
                    <button onclick="loadUsers()" class="btn-refresh"><i class="fas fa-sync-alt"></i> تحديث القائمة</button>
                </div>
                
                <div id="loadingUsers" class="loading-spinner hidden">
                    <i class="fas fa-circle-notch fa-spin fa-2x"></i>
                    <p>جاري جلب بيانات السيرفر...</p>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>المعرف</th>
                                <th>الاسم الكامل</th>
                                <th>البريد الإلكتروني</th>
                                <th>الرتبة</th>
                                <th>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="coursesSection" class="content-section hidden">
            <div class="card">
                <h3><i class="fas fa-book-open"></i> دوراتي التعليمية</h3>
                <p>هذا القسم مخصص لعرض الدورات التدريبية المسجلة باسمك.</p>
            </div>
        </div>

        <div id="marketingSection" class="content-section hidden">
            <div class="card">
                <h3><i class="fas fa-dollar-sign"></i> نظام التسويق بالعمولة</h3>
                <p>هنا تظهر إحصائياتك كمندوب مسوق للأكاديمية.</p>
            </div>
        </div>
    </div>

    <div id="promoteModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-user-edit fa-3x" style="color: var(--secondary); margin-bottom: 15px;"></i>
            <h3>تغيير رتبة المستخدم</h3>
            <p id="targetUserName" style="font-weight: bold; color: #555;"></p>
            <input type="hidden" id="targetUserId">
            
            <select id="newRoleSelect" class="modal-input">
                <option value="ROL-00000004">طالب (افتراضي)</option>
                <option value="ROL-00000003">مندوب (مسوق)</option>
                <option value="ROL-00000002">موظف / معلم</option>
                <option value="ROL-00000001">مدير نظام</option>
            </select>
            
            <div class="modal-btns">
                <button class="btn-save" id="savePromoteBtn" onclick="executePromotion()">حفظ وتفعيل</button>
                <button class="btn-cancel" onclick="closeModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <script src="url/url.js"></script>
    <script>
        // دالة التحكم في القائمة الجانبية
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // دالة تبديل الأقسام
        function showSection(sectionId, element) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if(element) element.classList.add('active');

            if(window.innerWidth <= 768) toggleSidebar();
        }

        const rolesMap = {
            "ROL-00000001": "مدير",
            "ROL-00000002": "موظف",
            "ROL-00000003": "مندوب",
            "ROL-00000004": "طالب"
        };

        // تحديث واجهة المستخدم بناءً على الرتبة
        function updateUIMenu(roleId, name) {
            document.getElementById("userName").innerText = name || "مستخدم";
            document.getElementById("debugInfo").innerText = "معرف الدور المسجل: " + roleId;
            document.getElementById("roleText").innerText = "رتبة: " + (rolesMap[roleId] || "طالب");

            document.getElementById("studentMenu").classList.add("hidden");
            document.getElementById("affiliateMenu").classList.add("hidden");
            document.getElementById("adminMenu").classList.add("hidden");

            if (roleId === "ROL-00000001") {
                document.getElementById("adminMenu").classList.remove("hidden");
                document.getElementById("affiliateMenu").classList.remove("hidden");
                document.getElementById("studentMenu").classList.remove("hidden");
            } else if (roleId === "ROL-00000003") {
                document.getElementById("affiliateMenu").classList.remove("hidden");
                document.getElementById("studentMenu").classList.remove("hidden");
            } else {
                document.getElementById("studentMenu").classList.remove("hidden");
            }
        }

        // جلب قائمة المستخدمين للمدير
        async function loadUsers() {
            const list = document.getElementById("usersList");
            const loader = document.getElementById("loadingUsers");
            list.innerHTML = "";
            loader.classList.remove("hidden");

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "getAllUsers" })
                });
                const result = await response.json();
                loader.classList.add("hidden");

                if(result.success) {
                    result.users.forEach(user => {
                        const row = `<tr>
                            <td>${user.معرف_المستخدم}</td>
                            <td>${user.الاسم_الكامل}</td>
                            <td>${user.البريد_الإلكتروني}</td>
                            <td><span class="badge ${user.معرف_الدور === 'ROL-00000001' ? 'badge-admin' : 'badge-student'}">
                                ${rolesMap[user.معرف_الدور] || 'طالب'}
                            </span></td>
                            <td>
                                <button class="btn-promote" onclick="openPromoteModal('${user.معرف_المستخدم}', '${user.الاسم_الكامل}', '${user.معرف_الدور}')">
                                    <i class="fas fa-user-cog"></i> تعديل
                                </button>
                            </td>
                        </tr>`;
                        list.innerHTML += row;
                    });
                }
            } catch (err) { loader.innerHTML = "فشل جلب البيانات من السيرفر"; }
        }

        // وظائف النافذة المنبثقة
        function openPromoteModal(userId, userName, currentRole) {
            document.getElementById("targetUserId").value = userId;
            document.getElementById("targetUserName").innerText = userName;
            document.getElementById("newRoleSelect").value = currentRole;
            document.getElementById("promoteModal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("promoteModal").style.display = "none";
        }

        // تنفيذ عملية الترقية عبر السيرفر
        async function executePromotion() {
            const userId = document.getElementById("targetUserId").value;
            const targetRole = document.getElementById("newRoleSelect").value;
            const btn = document.getElementById("savePromoteBtn");

            if(!confirm("تحذير: هذه العملية ستقوم بتغيير هوية المستخدم الرقمية وتوزيعه في الجداول التخصصية. هل تريد المتابعة؟")) return;

            btn.disabled = true;
            btn.innerText = "جاري الحفظ...";

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "promoteUser",
                        payload: { userId: userId, targetRole: targetRole }
                    })
                });
                const result = await response.json();
                if(result.success) {
                    alert("تمت الترقية بنجاح! المعرف الجديد للمستخدم هو: " + result.newId);
                    closeModal();
                    loadUsers(); 
                } else {
                    alert("خطأ: " + result.message);
                }
            } catch (e) { alert("حدث خطأ في الاتصال بالسيرفر"); }
            finally {
                btn.disabled = false;
                btn.innerText = "حفظ وتفعيل";
            }
        }

        // التحقق عند تحميل الصفحة
        window.onload = async function() {
            const userId = localStorage.getItem("userId");
            let roleId = localStorage.getItem("userRole");
            const name = localStorage.getItem("userName");

            if (!userId) { window.location.href = "auth.html"; return; }

            updateUIMenu(roleId, name);

            // تحديث الرتبة من السيرفر للتأكد من المزامنة
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "getCurrentRole", payload: { userId: userId } })
                });
                const result = await response.json();
                if (result.success && result.roleId !== roleId) {
                    localStorage.setItem("userRole", result.roleId);
                    updateUIMenu(result.roleId, name);
                }
            } catch (e) { console.error("Sync Error"); }
        }

        function logout() { 
            localStorage.clear(); 
            window.location.href = "auth.html"; 
        }
    </script>
</body>
</html>
